name: Sync DEG Updates

on:
  # 每天 UTC 时间 2:00 检查一次（北京时间 10:00）
  schedule:
    - cron: '0 2 * * *'
  # 也可以手动触发
  workflow_dispatch:
  # 当 double-entry-generator 发布新版本时触发（通过 webhook）
  repository_dispatch:
    types: [deg-updated]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-deg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout beanBridge
        uses: actions/checkout@v4
        with:
          path: beanBridge

      - name: Checkout double-entry-generator
        uses: actions/checkout@v4
        with:
          repository: deb-sig/double-entry-generator
          path: double-entry-generator
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build WASM
        working-directory: double-entry-generator
        run: |
          make build-wasm
          ls -lh wasm-dist/

      - name: Copy wasm_exec.js if missing
        working-directory: double-entry-generator
        run: |
          # 如果 wasm_exec.js 不在 wasm-dist 目录中，从 GOROOT 复制
          if [ ! -f "wasm-dist/wasm_exec.js" ]; then
            echo "wasm_exec.js not found in wasm-dist, copying from GOROOT..."
            GOROOT=$(go env GOROOT)
            # 尝试新路径 (Go 1.24+)
            if [ -f "$GOROOT/lib/wasm/wasm_exec.js" ]; then
              cp "$GOROOT/lib/wasm/wasm_exec.js" wasm-dist/
              echo "Copied from $GOROOT/lib/wasm/wasm_exec.js"
            # 尝试旧路径 (Go < 1.24)
            elif [ -f "$GOROOT/misc/wasm/wasm_exec.js" ]; then
              cp "$GOROOT/misc/wasm/wasm_exec.js" wasm-dist/
              echo "Copied from $GOROOT/misc/wasm/wasm_exec.js"
            else
              echo "Error: wasm_exec.js not found in GOROOT"
              echo "GOROOT: $GOROOT"
              ls -la "$GOROOT/lib/wasm/" 2>/dev/null || echo "lib/wasm not found"
              ls -la "$GOROOT/misc/wasm/" 2>/dev/null || echo "misc/wasm not found"
              exit 1
            fi
          else
            echo "wasm_exec.js already exists in wasm-dist"
          fi
          ls -lh wasm-dist/

      - name: Copy WASM files
        run: |
          mkdir -p beanBridge/public/wasm
          cp double-entry-generator/wasm-dist/double-entry-generator.wasm beanBridge/public/wasm/
          cp double-entry-generator/wasm-dist/wasm_exec.js beanBridge/public/wasm/
          ls -lh beanBridge/public/wasm/

      - name: Sync example configs
        run: |
          # 同步所有 provider 的示例配置文件
          cd double-entry-generator
          if [ ! -d "example" ]; then
            echo "Warning: example directory not found"
            exit 0
          fi
          for provider_dir in example/*/; do
            # 检查目录是否存在（避免 glob 失败的情况）
            [ -d "$provider_dir" ] || continue
            provider=$(basename "$provider_dir")
            if [ -f "$provider_dir/config.yaml" ]; then
              echo "Syncing config for $provider..."
              mkdir -p "../beanBridge/public/example/$provider"
              cp "$provider_dir/config.yaml" "../beanBridge/public/example/$provider/" || {
                echo "Warning: Failed to copy config for $provider"
              }
            fi
          done
          echo "Synced example configs:"
          ls -la ../beanBridge/public/example/ || echo "No example configs synced"

      - name: Check for changes
        id: changes
        working-directory: beanBridge
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/wasm/ public/example/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git status
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beanBridge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="auto-sync-deg-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          git commit -m "chore: auto-sync DEG updates

          - Update WASM files from double-entry-generator
          - Sync example configurations
          - Auto-generated by GitHub Actions"
          git push origin "$BRANCH_NAME"
          
          # 创建 PR
          gh pr create \
            --title "Auto-sync DEG updates" \
            --body "This PR automatically syncs updates from double-entry-generator:
          - Updated WASM files
          - Synced example configurations
          
          Auto-generated by GitHub Actions workflow." \
            --base main \
            --head "$BRANCH_NAME" || echo "PR creation failed or already exists"

      - name: Direct commit to main (if workflow_dispatch)
        if: steps.changes.outputs.has_changes == 'true' && github.event_name == 'workflow_dispatch'
        working-directory: beanBridge
        run: |
          git checkout main
          git merge "$BRANCH_NAME" || true
          git push origin main || echo "Push failed"

