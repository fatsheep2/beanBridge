import{d as H,r as p,i as V,n as P,c as i,a as e,b as C,e as f,t as y,l as I,p as K,o as n,j as O,g as E,w as G,h as J,k as Q,F as X,q as Z,m as ee,u as te,s as re}from"./vendor-BLEgdA3F.js";import{a as j,u as oe,y as v}from"./useDegWasm-DG6VwMc1.js";import{p as z,_ as le}from"./ProviderSelector.vue_vue_type_script_setup_true_lang-DIqK479G.js";import"./wasm-CActu_x9.js";const ae={class:"yaml-config-editor"},se={key:0,class:"mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg"},ne={class:"flex items-center"},ie={class:"text-red-800 dark:text-red-200 text-sm"},de={key:1,class:"mb-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg"},ue={class:"flex items-center"},ce={class:"text-green-800 dark:text-green-200 text-sm"},ge={class:"relative"},ve={key:0,class:"absolute inset-0 flex items-center justify-center bg-white/50 dark:bg-gray-900/50"},pe={class:"mt-2 text-xs text-gray-500 dark:text-gray-400"},fe=H({__name:"YamlConfigEditor",props:{modelValue:{},provider:{}},emits:["update:modelValue","validated"],setup(B,{expose:A,emit:_}){const d=B,l=_,a=p(d.modelValue||""),u=p(null),c=p(null),b=p(!1),m=V(()=>a.value.split(`
`).length);P(()=>d.modelValue,o=>{o!==a.value&&(a.value=o)}),P(a,o=>{l("update:modelValue",o),u.value=null,c.value=null});const k=()=>{u.value=null,c.value=null},x=()=>{try{const o=j.parse(a.value);a.value=j.stringify(o,{indent:2,lineWidth:0,minContentWidth:0}),c.value="格式化成功",setTimeout(()=>{c.value=null},2e3)}catch(o){u.value=`格式化失败: ${o instanceof Error?o.message:String(o)}`}},w=()=>{try{const o=j.parse(a.value);if(!o||typeof o!="object")throw new Error("配置必须是对象格式");if(!o.defaultMinusAccount)throw new Error("缺少必需字段: defaultMinusAccount");if(!o.defaultPlusAccount)throw new Error("缺少必需字段: defaultPlusAccount");if(!o.defaultCurrency)throw new Error("缺少必需字段: defaultCurrency");if(d.provider&&o[d.provider]){const s=o[d.provider];if(s.rules&&!Array.isArray(s.rules))throw new Error(`${d.provider}.rules 必须是数组`)}u.value=null,c.value="YAML 配置验证通过",l("validated",!0),setTimeout(()=>{c.value=null},2e3)}catch(o){u.value=`验证失败: ${o instanceof Error?o.message:String(o)}`,l("validated",!1)}};return A({formatYaml:x,validateYaml:w,getContent:()=>a.value,setContent:o=>{a.value=o}}),(o,s)=>(n(),i("div",ae,[e("div",{class:"flex items-center justify-between mb-4"},[s[3]||(s[3]=e("h3",{class:"text-lg font-semibold"},"YAML 配置编辑器",-1)),e("div",{class:"flex gap-3"},[e("button",{onClick:x,class:"inline-flex items-center px-7 py-3.5 text-base font-bold bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-500 rounded-xl shadow-lg transition-all duration-200"},s[1]||(s[1]=[e("span",{class:"material-icons text-lg mr-2"},"format_align_left",-1),f(" 格式化 ")])),e("button",{onClick:w,class:"inline-flex items-center px-7 py-3.5 text-base font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-xl shadow-lg transition-all duration-200"},s[2]||(s[2]=[e("span",{class:"material-icons text-lg mr-2"},"check_circle",-1),f(" 验证 ")]))])]),u.value?(n(),i("div",se,[e("div",ne,[s[4]||(s[4]=e("span",{class:"material-icons text-red-600 dark:text-red-400 mr-2"},"error",-1)),e("span",ie,y(u.value),1)])])):C("",!0),c.value?(n(),i("div",de,[e("div",ue,[s[5]||(s[5]=e("span",{class:"material-icons text-green-600 dark:text-green-400 mr-2"},"check_circle",-1)),e("span",ce,y(c.value),1)])])):C("",!0),e("div",ge,[I(e("textarea",{"onUpdate:modelValue":s[0]||(s[0]=$=>a.value=$),class:"w-full h-96 p-4 font-mono text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 resize-none",placeholder:"请输入 YAML 配置...",onInput:k},null,544),[[K,a.value]]),b.value?(n(),i("div",ve,s[6]||(s[6]=[e("div",{class:"text-gray-600 dark:text-gray-300"},"加载中...",-1)]))):C("",!0)]),e("div",pe," 行数: "+y(m.value)+" | 字符数: "+y(a.value.length),1)]))}}),xe={class:"w-full min-h-screen bg-gray-50 dark:bg-gray-900 px-6 sm:px-12 lg:px-24 py-8"},ye={class:"flex items-center justify-between mb-8"},be={class:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6"},me={key:1,class:"p-4 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-700"},he={key:0,class:"space-y-6"},ke={class:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6"},we={class:"flex flex-col sm:flex-row sm:items-center justify-between gap-4"},Ce={class:"text-xl font-semibold text-gray-900 dark:text-white"},_e={class:"flex gap-4"},Me=["disabled"],Ae={key:0,class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},$e={key:1,class:"w-6 h-6 mr-3 animate-spin",fill:"none",viewBox:"0 0 24 24"},je={class:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6"},Ve={class:"flex flex-wrap justify-end gap-4"},Pe=["disabled"],Be=["disabled"],Ee={key:0,class:"w-7 h-7 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},ze={key:1,class:"w-7 h-7 mr-3 animate-spin",fill:"none",viewBox:"0 0 24 24"},He=["disabled"],Le={key:1,class:"text-center py-12"},Ye={key:2,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},Fe={class:"bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto border border-gray-200 dark:bg-gray-800 dark:border-gray-700"},Te={class:"flex items-center justify-between mb-6"},De={class:"space-y-2"},Ne=["onClick"],Se={class:"flex items-center justify-between"},Re={class:"font-medium"},qe={class:"text-sm text-gray-600 dark:text-gray-300"},We={class:"flex space-x-2"},Ue=["onClick"],Ie={key:0,class:"text-center py-12 text-gray-500 dark:text-gray-400"},Qe=H({__name:"YamlConfigView",setup(B){const A=te(),_=ee(),d=oe(),l=p(null),a=p(""),u=p(!1),c=p(!1),b=p(!1),m=p(!1),k=p(null),x=V(()=>{const r=d.supportedProviders.value;return r.length>0?r.map(t=>z.find(g=>g.type===t)).filter(t=>t!==void 0):z.filter(t=>["alipay","wechat","icbc","ccb","citic","cmb","huobi","htsec","hxsec","mt","jd","bmo","td","hsbchk"].includes(t.type))}),w=V(()=>l.value?v.getHistory(l.value):[]),o=async r=>{l.value=r;try{await d.setProvider(r),s()}catch(t){console.error("设置 Provider 失败:",t)}},s=()=>{if(!l.value)return;const r=v.getConfig(l.value);r?a.value=r:a.value=v.getDefaultConfig(l.value)},$=async()=>{if(l.value){c.value=!0;try{const r=await v.loadFromExample(l.value);r?(a.value=r,k.value&&k.value.validateYaml(),alert("示例配置加载成功！")):alert("无法加载示例配置，请检查网络连接或手动创建配置")}catch(r){console.error("Failed to load example:",r),alert("加载示例配置失败")}finally{c.value=!1}}},L=async()=>{if(!(!l.value||!u.value))try{const r=v.validateConfig(a.value);if(!r.valid){alert(`配置验证失败: ${r.error}`);return}v.saveConfig(l.value,a.value),await d.updateConfig(r.config),alert("配置保存成功！")}catch(r){console.error("Failed to save config:",r),alert("保存配置失败")}},Y=()=>{if(!l.value)return;const r=v.exportConfig(l.value);r?navigator.clipboard.writeText(r).then(()=>{alert("配置已复制到剪贴板！")}).catch(()=>{alert("复制失败，请重试")}):alert("没有可导出的配置")},F=async()=>{try{const r=await navigator.clipboard.readText();if(!r){alert("剪贴板为空");return}const t=v.validateConfig(r);if(!t.valid){alert(`配置格式错误: ${t.error}`);return}if(l.value)v.importConfig(l.value,r),a.value=r,alert("配置导入成功！");else{const M=t.config,g=Object.keys(M).filter(h=>!["defaultMinusAccount","defaultPlusAccount","defaultCurrency","title","defaultCashAccount","defaultCommissionAccount","defaultPositionAccount","defaultPnlAccount"].includes(h));if(g.length>0){const h=g[0];confirm(`检测到配置为 ${h}，是否使用此解析器？`)&&(await o(h),a.value=r,alert("配置导入成功！"))}else alert("无法从配置中检测到解析器，请先选择解析器")}}catch(r){console.error("Failed to import config:",r),alert("导入配置失败")}},T=async()=>{if(!(!l.value||!u.value)){b.value=!0;try{const r=v.validateConfig(a.value);r.config&&await d.updateConfig(r.config),_.push({path:"/bill-processing",query:{provider:l.value,from:"yaml-config",test:"true"}})}catch(r){console.error("Failed to test config:",r),alert("测试配置失败")}finally{b.value=!1}}},D=()=>{l.value&&_.push({path:"/bill-processing",query:{provider:l.value,from:"yaml-config"}})},N=r=>{const t=v.applyHistory(r);t?(a.value=t,m.value=!1,alert("历史配置应用成功！")):alert("应用历史配置失败")},S=r=>{confirm("确定要删除这个历史记录吗？")&&(v.deleteHistory(r)?(m.value=!1,alert("历史记录删除成功！")):alert("删除失败，请重试"))},R=r=>new Date(r).toLocaleString("zh-CN"),q=r=>{u.value=r},W=r=>d.getProviderDisplayName(r),U=()=>{const r=A.query.provider;r?o(r):x.value.length>0&&!l.value&&o(x.value[0].type)};return P(l,()=>{s()}),O(async()=>{try{await d.init(),await new Promise(r=>setTimeout(r,200)),d.supportedProviders.value.length===0&&console.warn("WASM 未返回支持的 providers，使用默认列表"),U()}catch(r){console.error("初始化失败:",r),x.value.length>0&&!l.value&&o(x.value[0].type)}}),(r,t)=>{const M=J("router-link");return n(),i("div",xe,[e("div",ye,[t[4]||(t[4]=e("h1",{class:"text-3xl font-bold text-gray-900 dark:text-white"},"YAML 规则配置",-1)),E(M,{to:"/",class:"inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:text-gray-900 dark:hover:text-white transition-colors"},{default:G(()=>t[3]||(t[3]=[e("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})],-1),f(" 返回首页 ")])),_:1,__:[3]})]),e("div",be,[t[6]||(t[6]=e("h2",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-4"},"选择解析器",-1)),x.value.length>0?(n(),Q(le,{key:0,"supported-providers":x.value,"selected-provider":l.value,onProviderSelected:o},null,8,["supported-providers","selected-provider"])):(n(),i("div",me,t[5]||(t[5]=[e("p",{class:"text-gray-600 dark:text-gray-400 text-sm"},"正在加载解析器列表...",-1)])))]),l.value?(n(),i("div",he,[e("div",ke,[e("div",we,[e("div",null,[e("h3",Ce,y(W(l.value)),1),t[7]||(t[7]=e("p",{class:"text-sm text-gray-600 dark:text-gray-300 mt-1"},"使用 double-entry-generator 的 YAML 配置格式",-1))]),e("div",_e,[e("button",{onClick:$,class:"inline-flex items-center px-8 py-4 text-lg font-bold bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-500 rounded-2xl shadow-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-white dark:disabled:hover:bg-gray-800",disabled:c.value},[c.value?(n(),i("svg",$e,t[9]||(t[9]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(n(),i("svg",Ae,t[8]||(t[8]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"},null,-1)]))),f(" "+y(c.value?"加载中...":"加载示例"),1)],8,Me),e("button",{onClick:t[0]||(t[0]=g=>m.value=!0),class:"inline-flex items-center px-8 py-4 text-lg font-bold bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-500 rounded-2xl shadow-xl transition-all duration-200"},t[10]||(t[10]=[e("svg",{class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),f(" 历史 ")]))])]),e("div",{class:"flex gap-4 mt-4"},[e("button",{onClick:Y,class:"inline-flex items-center px-8 py-4 text-lg font-bold text-white bg-green-600 hover:bg-green-700 rounded-2xl shadow-xl transition-all duration-200"},t[11]||(t[11]=[e("svg",{class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})],-1),f(" 导出 ")])),e("button",{onClick:F,class:"inline-flex items-center px-8 py-4 text-lg font-bold text-white bg-purple-600 hover:bg-purple-700 rounded-2xl shadow-xl transition-all duration-200"},t[12]||(t[12]=[e("svg",{class:"w-6 h-6 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})],-1),f(" 导入 ")]))])]),e("div",je,[E(fe,{modelValue:a.value,"onUpdate:modelValue":t[1]||(t[1]=g=>a.value=g),provider:l.value,onValidated:q,ref_key:"yamlEditorRef",ref:k},null,8,["modelValue","provider"])]),e("div",Ve,[e("button",{onClick:L,class:"inline-flex items-center px-12 py-5 text-xl font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-2xl shadow-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-blue-600",disabled:!u.value},t[13]||(t[13]=[e("svg",{class:"w-7 h-7 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"})],-1),f(" 保存配置 ")]),8,Pe),e("button",{onClick:T,class:"inline-flex items-center px-12 py-5 text-xl font-bold text-white bg-yellow-600 hover:bg-yellow-700 rounded-2xl shadow-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-yellow-600",disabled:!u.value||b.value},[b.value?(n(),i("svg",ze,t[15]||(t[15]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(n(),i("svg",Ee,t[14]||(t[14]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"},null,-1)]))),f(" "+y(b.value?"测试中...":"测试配置"),1)],8,Be),e("button",{onClick:D,class:"inline-flex items-center px-12 py-5 text-xl font-bold text-white bg-green-600 hover:bg-green-700 rounded-2xl shadow-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-green-600",disabled:!u.value},t[16]||(t[16]=[e("svg",{class:"w-7 h-7 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1),f(" 处理账单 ")]),8,He)])])):(n(),i("div",Le,t[17]||(t[17]=[e("span",{class:"material-icons text-4xl text-gray-400 dark:text-gray-500 mb-4"},"storage",-1),e("p",{class:"text-gray-600 dark:text-gray-300"},"请先选择一个解析器来配置规则",-1)]))),m.value?(n(),i("div",Ye,[e("div",Fe,[e("div",Te,[t[19]||(t[19]=e("h3",{class:"text-2xl font-bold"},"历史记录",-1)),e("button",{onClick:t[2]||(t[2]=g=>m.value=!1),class:"text-gray-400 hover:text-gray-600 dark:text-gray-500 text-2xl"},t[18]||(t[18]=[e("span",{class:"material-icons"},"close",-1)]))]),e("div",De,[(n(!0),i(X,null,Z(w.value,g=>(n(),i("div",{key:g.id,class:"border-2 border-gray-100 dark:border-gray-800 rounded-xl p-4 hover:bg-gray-100 dark:hover:bg-gray-900 cursor-pointer",onClick:h=>N(g.id)},[e("div",Se,[e("div",null,[e("h4",Re,y(g.provider),1),e("p",qe,y(R(g.createdAt)),1)]),e("div",We,[t[21]||(t[21]=e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"}," 应用 ",-1)),e("button",{onClick:re(h=>S(g.id),["stop"]),class:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"},t[20]||(t[20]=[e("span",{class:"material-icons text-sm"},"delete",-1)]),8,Ue)])])],8,Ne))),128))]),w.value.length===0?(n(),i("div",Ie," 暂无历史记录 ")):C("",!0)])])):C("",!0)])}}});export{Qe as default};
