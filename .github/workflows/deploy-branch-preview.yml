name: Deploy Branch Preview to GitHub Pages

on:
  push:
    branches:
      # ç›‘å¬æ‰€æœ‰åŠŸèƒ½åˆ†æ”¯ï¼Œæ’é™¤ä¸»åˆ†æ”¯
      - feat/**
      - fix/**
      - dev/**
      - auto-sync-deg-*  # è‡ªåŠ¨åŒæ­¥ DEG çš„åˆ†æ”¯
      - wasm-support  # ä¸´æ—¶æ”¯æŒæ—§åˆ†æ”¯å
      - '!main'
      - '!master'
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (e.g., feat/wasm-support)'
        required: true
        default: 'feat/wasm-support'

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write         # éœ€è¦å†™æƒé™ä»¥æ¨é€åˆ° gh-pages åˆ†æ”¯
  pull-requests: write    # éœ€è¦å†™æƒé™ä»¥åœ¨ PR ä¸­å‘è¡¨è¯„è®º
  issues: write           # éœ€è¦å†™æƒé™ä»¥åœ¨ Issue ä¸­å‘è¡¨è¯„è®º

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼ˆæ¯ä¸ªåˆ†æ”¯ç‹¬ç«‹ï¼‰
# ä½¿ç”¨åˆ†æ”¯åä½œä¸º groupï¼Œç¡®ä¿åŒä¸€åˆ†æ”¯/PR åªæœ‰ä¸€ä¸ªé¢„è§ˆç¯å¢ƒ
concurrency:
  group: "pages-preview-${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}"
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„éƒ¨ç½²ï¼Œç­‰å¾…å®Œæˆï¼ˆé¿å…é¢‘ç¹å–æ¶ˆï¼‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Get branch name
        id: branch-name
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch }}"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR äº‹ä»¶ä½¿ç”¨ head ref
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
          fi
          # æ¸…ç†åˆ†æ”¯åï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™æ–œæ ç”¨äºå±‚çº§
          CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9\/-]/-/g')
          echo "name=$CLEAN_BRANCH" >> $GITHUB_OUTPUT
          echo "original=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch name: $BRANCH_NAME -> $CLEAN_BRANCH"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || (github.event_name == 'pull_request' && github.head_ref || github.ref_name) }}

      - name: Verify WASM files
        run: |
          # æ£€æŸ¥ WASM æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨äºä»“åº“ä¸­
          if [ -f "public/wasm/double-entry-generator.wasm" ] && [ -f "public/wasm/wasm_exec.js" ]; then
            echo "âœ“ WASM æ–‡ä»¶å·²å­˜åœ¨äºä»“åº“ä¸­ï¼Œè·³è¿‡æ„å»ºæ­¥éª¤"
            ls -lh public/wasm/
          else
            echo "âœ— WASM æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·ç¡®ä¿å·²æäº¤ WASM æ–‡ä»¶åˆ°ä»“åº“"
            echo "è¿è¡Œä»¥ä¸‹å‘½ä»¤æ„å»ºå¹¶æäº¤ WASM æ–‡ä»¶ï¼š"
            echo "  cd double-entry-generator && make build-wasm"
            echo "  cp double-entry-generator/wasm-dist/* public/wasm/"
            echo "  git add public/wasm/ && git commit -m 'Add WASM files'"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        id: pnpm-cache
        run: |
          echo "pnpm_cache_dir=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          BRANCH_NAME: ${{ steps.branch-name.outputs.name }}
        run: |
          # ä½¿ç”¨åˆ†æ”¯åä½œä¸º base path
          pnpm run build --base /beanBridge/$BRANCH_NAME/

      - name: Deploy to GitHub Pages (Branch Subdirectory)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          destination_dir: ${{ steps.branch-name.outputs.name }}  # éƒ¨ç½²åˆ°åˆ†æ”¯åå­ç›®å½•
          keep_files: true  # ä¿ç•™å…¶ä»–éƒ¨ç½²çš„æ–‡ä»¶
          commit_message: "Deploy ${{ steps.branch-name.outputs.original }} branch preview"
      
      - name: Comment PR with preview link
        uses: actions/github-script@v7
        continue-on-error: true  # å¦‚æœè¯„è®ºå¤±è´¥ä¸å½±å“éƒ¨ç½²
        with:
          script: |
            const branchName = '${{ steps.branch-name.outputs.name }}';
            const repoName = context.repo.repo;
            const repoOwner = context.repo.owner;
            const previewUrl = `https://${repoOwner}.github.io/${repoName}/${branchName}/`;
            const originalBranch = '${{ steps.branch-name.outputs.original }}';
            
            console.log(`âœ… é¢„è§ˆéƒ¨ç½²æˆåŠŸï¼`);
            console.log(`ğŸ“ é¢„è§ˆåœ°å€: ${previewUrl}`);
            console.log(`ğŸ“ åˆ†æ”¯: ${originalBranch}`);
            
            try {
              let prNumber;
              if (context.eventName === 'pull_request') {
                // PR äº‹ä»¶ç›´æ¥ä½¿ç”¨ PR number
                prNumber = context.payload.pull_request.number;
              } else {
                // Push æˆ– workflow_dispatch äº‹ä»¶éœ€è¦æŸ¥æ‰¾ç›¸å…³çš„ PR
                const branchRef = context.eventName === 'workflow_dispatch' 
                  ? originalBranch 
                  : context.ref.replace('refs/heads/', '');
                
                console.log(`æŸ¥æ‰¾åˆ†æ”¯ ${branchRef} ç›¸å…³çš„ PR...`);
                const prs = await github.rest.pulls.list({
                  owner: repoOwner,
                  repo: repoName,
                  state: 'open',
                  head: `${repoOwner}:${branchRef}`
                });
                if (prs.data.length > 0) {
                  prNumber = prs.data[0].number;
                  console.log(`æ‰¾åˆ° PR #${prNumber}`);
                } else {
                  console.log(`æœªæ‰¾åˆ°åˆ†æ”¯ ${branchRef} çš„å¼€æ”¾ PR`);
                }
              }
              
              if (prNumber) {
                await github.rest.issues.createComment({
                  owner: repoOwner,
                  repo: repoName,
                  issue_number: prNumber,
                  body: `ğŸ‰ **é¢„è§ˆéƒ¨ç½²æˆåŠŸï¼**\n\nâœ¨ é¢„è§ˆåœ°å€: ${previewUrl}\n\nğŸ“ åˆ†æ”¯: \`${originalBranch}\`\nâ° éƒ¨ç½²æ—¶é—´: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}`
                });
                console.log(`âœ… å·²åœ¨ PR #${prNumber} ä¸­æ·»åŠ è¯„è®º`);
              } else {
                console.log(`â„¹ï¸  æœªæ‰¾åˆ°ç›¸å…³çš„ PRï¼Œè·³è¿‡è¯„è®º`);
              }
            } catch (error) {
              console.log(`âš ï¸  æ·»åŠ è¯„è®ºå¤±è´¥ï¼ˆè¿™ä¸å½±å“éƒ¨ç½²ï¼‰: ${error.message}`);
            }

