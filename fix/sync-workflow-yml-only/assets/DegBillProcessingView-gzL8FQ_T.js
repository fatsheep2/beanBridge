import{h as te,n as q,c as G,z as se,A as ae,w as Z,e as oe,C as le,D as ne,t as re,x as ie,_ as K,f as ue}from"./index-DhnbvQSW.js";import{N as ce}from"./index-Vfahpi2s.js";import{s as de,c as ve,F as me}from"./FileUploadSection-C2axcBl0.js";import{B as Y,T as pe,p as J,P as ge}from"./ProviderSelector-Dqg_d2Yi.js";import{d as U,l as fe,e as m,B as he,c as P,r as A,h as D,w as h,i as f,b as n,a as F,x as V,j as R,t as b,F as W,y as O,J as ye,o as _e,A as we,f as be}from"./vendor-axiUcNeZ.js";import{u as H,y as L}from"./useDegWasm-BrXyuhkt.js";import"./wasm-DmpUyrXp.js";import{C as Pe,a as Ce,E as xe,y as I}from"./index-yMH30zzs.js";import"./use-expose-CIH7fYgk.js";import"./index-BQuVhw87.js";const[Q,Se]=G("radio-group"),ke={shape:String,disabled:Boolean,iconSize:q,direction:String,modelValue:te,checkedColor:String},ee=Symbol(Q);var $e=U({name:Q,props:ke,emits:["change","update:modelValue"],setup(i,{emit:S,slots:y}){const{linkChildren:s}=se(ee),o=d=>S("update:modelValue",d);return fe(()=>i.modelValue,d=>S("change",d)),s({props:i,updateValue:o}),ae(()=>i.modelValue),()=>{var d;return m("div",{class:Se([i.direction]),role:"radiogroup"},[(d=y.default)==null?void 0:d.call(y)])}}});const Fe=Z($e),Te=oe({},ve,{shape:String}),[Be,Re]=G("radio");var Ve=U({name:Be,props:Te,emits:["update:modelValue"],setup(i,{emit:S,slots:y}){const{parent:s}=le(ee),o=()=>(s?s.props.modelValue:i.modelValue)===i.name,d=()=>{s?s.updateValue(i.name):S("update:modelValue",i.name)};return()=>m(de,he({bem:Re,role:"radio",parent:s,checked:o(),onToggle:d},i),ne(y,["default","icon"]))}});const Me=Z(Ve),[De,X]=G("progress"),ze={color:String,inactive:Boolean,pivotText:String,textColor:String,showPivot:re,pivotColor:String,trackColor:String,strokeWidth:q,percentage:{type:q,default:0,validator:i=>+i>=0&&+i<=100}};var Ee=U({name:De,props:ze,setup(i){const S=P(()=>i.inactive?void 0:i.color),y=o=>Math.min(Math.max(+o,0),100),s=()=>{const{textColor:o,pivotText:d,pivotColor:_,percentage:C}=i,c=y(C),k=d??`${C}%`;if(i.showPivot&&k){const M={color:o,left:`${c}%`,transform:`translate(-${c}%,-50%)`,background:_||S.value};return m("span",{style:M,class:X("pivot",{inactive:i.inactive})},[k])}};return()=>{const{trackColor:o,percentage:d,strokeWidth:_}=i,C=y(d),c={background:o,height:ie(_)},k={width:`${C}%`,background:S.value};return m("div",{class:X(),style:c},[m("span",{class:X("portion",{inactive:i.inactive}),style:k},null),s()])}}});const Ie=Z(Ee);function Ae(){const i=H(),S=A(null),y=A(!1),s=A(null),o=A(null),d=A("beancount"),_=async($,p="beancount")=>{if(!i.currentProvider.value){o.value="è¯·å…ˆé€‰æ‹©è§£æå™¨";return}y.value=!0,o.value=null,s.value=null;try{i.isInitialized.value||await i.init(),console.log(`[useDegFileProcessing] å¤„ç†æ–‡ä»¶ï¼Œå½“å‰ provider: ${i.currentProvider.value}`),await i.setProvider(i.currentProvider.value),await new Promise(a=>setTimeout(a,150));const x=await i.processFile($,p);x.success?(s.value=x,o.value=null):(o.value=x.error||"å¤„ç†æ–‡ä»¶å¤±è´¥",s.value=null)}catch(x){console.error("æ–‡ä»¶å¤„ç†å¤±è´¥:",x),o.value=x instanceof Error?x.message:"å¤„ç†æ–‡ä»¶å¤±è´¥",s.value=null}finally{y.value=!1}};return{selectedFile:S,isProcessing:y,processingResult:s,error:o,outputFormat:d,processFile:_,previewFile:async $=>{await _($,d.value)},reset:()=>{S.value=null,s.value=null,o.value=null,y.value=!1},downloadResult:$=>{var u;if(!((u=s.value)!=null&&u.output)){o.value="æ²¡æœ‰å¯ä¸‹è½½çš„æ•°æ®";return}const p=new Blob([s.value.output],{type:"text/plain"}),x=URL.createObjectURL(p),a=document.createElement("a");a.href=x,a.download=$||`beancount_${new Date().toISOString().split("T")[0]}.beancount`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(x)},copyToClipboard:async $=>{try{return await navigator.clipboard.writeText($),!0}catch(p){return console.error("å¤åˆ¶å¤±è´¥:",p),!1}}}}const je={class:"flex items-center justify-between pa-4"},Ue={class:"pa-4"},Le={class:"flex justify-between items-center mb-2"},Ne={class:"font-semibold"},We={class:"text-xs text-secondary mt-2"},Oe={key:0,class:"pa-4 pt-0"},Xe={class:"transaction-list transaction-grid"},qe={class:"text-xs text-secondary"},Ge={class:"font-mono text-sm"},Ze={key:1,class:"pa-4 suggestions-section"},Je={class:"suggestions-grid"},Ke={class:"suggestion-text"},Ye=U({__name:"RuleMatchAnalysis",props:{processedData:{},totalRecords:{}},emits:["close"],setup(i,{emit:S}){const y=i,s=P(()=>{if(!y.processedData)return[];const a=[],u=y.processedData.split(`
`);let r=null,v=!1;for(let T=0;T<u.length;T++){const B=u[T],z=B.trim();if(/^\d{4}-\d{2}-\d{2}\s+\*/.test(z)){r&&a.push(r);const t=z.match(/^(\d{4}-\d{2}-\d{2})\s+\*\s+"([^"]*)"\s+"([^"]*)"/);t&&(r={date:t[1],payee:t[2],narration:t[3],metadata:{},accounts:[],matchStatus:"matched",fixmeCount:0},v=!0)}else if(v&&r&&B.trim()&&/^\s+[A-Za-z:]+\s+[-]?\d+(?:\.\d+)?\s+\w+/.test(B)){const t=B.match(/^\s+([A-Za-z:]+)\s+([-]?\d+(?:\.\d+)?)\s+(\w+)/);if(t){const e=t[1],g=t[2],l=e.includes("FIXME");r.accounts.push({account:e,amount:g,isFIXME:l}),l&&r.fixmeCount++}}else if(v&&r&&B.trim()&&/^\s+\w+:/.test(B)){const t=B.match(/^\s+(\w+):\s*"?([^"]*)"?$/);t&&(r.metadata[t[1]]=t[2])}else v&&!z&&(r&&r.accounts.length>0&&(r.matchStatus=r.fixmeCount===0?"matched":r.fixmeCount>=r.accounts.length?"unmatched":"partial",a.push(r)),r=null,v=!1)}return r&&r.accounts.length>0&&(r.matchStatus=r.fixmeCount===0?"matched":r.fixmeCount>=r.accounts.length?"unmatched":"partial",a.push(r)),a}),o=P(()=>[...s.value].sort((a,u)=>{const r={unmatched:0,partial:1,matched:2};return r[a.matchStatus]-r[u.matchStatus]})),d=P(()=>s.value.length),_=P(()=>s.value.filter(a=>a.matchStatus==="unmatched").length),C=P(()=>s.value.filter(a=>a.matchStatus==="partial").length),c=P(()=>s.value.filter(a=>a.matchStatus==="matched").length),k=P(()=>d.value===0?0:c.value/d.value*100),M=a=>({unmatched:"danger",partial:"warning",matched:"success"})[a],$=a=>({unmatched:"æœªåŒ¹é…",partial:"åŠåŒ¹é…",matched:"å…¨åŒ¹é…"})[a],p=P(()=>{const a=[];if(_.value>0||C.value>0){const u=new Map;s.value.filter(v=>v.matchStatus==="unmatched"||v.matchStatus==="partial").forEach(v=>{v.payee&&v.payee!=="/"&&u.set(v.payee,(u.get(v.payee)||0)+1)});const r=Array.from(u.entries()).sort((v,T)=>T[1]-v[1])[0];r&&r[1]>1&&a.push(`å‘ç° ${r[1]} ç¬”æ¥è‡ªã€Œ${r[0]}ã€çš„äº¤æ˜“éœ€é…ç½®è§„åˆ™`),_.value+C.value>5&&a.push("å»ºè®®ä½¿ç”¨é€šé…ç¬¦æˆ–æ­£åˆ™åŒ¹é…ç›¸ä¼¼äº¤æ˜“"),C.value>0&&a.push(`æœ‰ ${C.value} ç¬”åŠåŒ¹é…ï¼Œå»ºè®®å®Œå–„è§„åˆ™`)}return a}),x=a=>{navigator.clipboard.writeText(a)};return(a,u)=>{const r=Y,v=Ce,T=Pe,B=Ie,z=pe,t=xe;return f(),D(T,{class:"rule-match-analysis",inset:""},{default:h(()=>[n("div",je,[u[2]||(u[2]=n("h3",{class:"section-title"},"è§„åˆ™åŒ¹é…åˆ†æ",-1)),m(r,{size:"small",plain:"",onClick:u[0]||(u[0]=e=>a.$emit("close"))},{default:h(()=>[...u[1]||(u[1]=[R("å…³é—­",-1)])]),_:1})]),m(T,{inset:"",class:"stats-group"},{default:h(()=>[m(v,{title:"æ€»è´¦å•æ•°",value:String(d.value)},null,8,["value"]),m(v,{title:"å…¨åŒ¹é…",value:String(c.value),"value-class":"match-success"},null,8,["value"]),m(v,{title:"åŠåŒ¹é…",value:String(C.value),"value-class":"match-partial"},null,8,["value"]),m(v,{title:"æœªåŒ¹é…",value:String(_.value),"value-class":"match-unmatch"},null,8,["value"])]),_:1}),n("div",Ue,[n("div",Le,[u[3]||(u[3]=n("span",{class:"text-sm text-secondary"},"è§„åˆ™è¦†ç›–ç‡",-1)),n("span",Ne,b(k.value.toFixed(1))+"%",1)]),m(B,{percentage:k.value,"stroke-width":8,"pivot-text":`${k.value.toFixed(1)}%`},null,8,["percentage","pivot-text"]),n("p",We,b(c.value)+" ç¬”å…¨åŒ¹é…ï¼Œ"+b(C.value)+" ç¬”åŠåŒ¹é…ï¼Œ"+b(_.value)+" ç¬”æœªåŒ¹é… ",1)]),o.value.length>0?(f(),F("div",Oe,[u[4]||(u[4]=n("h4",{class:"text-sm font-semibold mb-3"},"äº¤æ˜“æ˜ç»†",-1)),u[5]||(u[5]=n("p",{class:"text-xs text-secondary mb-3"},"ç‚¹å‡»è´¦æˆ·å¯å¤åˆ¶ï¼ŒFIXME éœ€é…ç½®è§„åˆ™",-1)),n("div",Xe,[(f(!0),F(W,null,O(o.value,(e,g)=>(f(),D(T,{key:g,inset:"",class:"tx-card"},{default:h(()=>[m(v,{border:!1},{title:h(()=>[m(z,{type:M(e.matchStatus),size:"medium",class:"mr-2"},{default:h(()=>[R(b($(e.matchStatus)),1)]),_:2},1032,["type"]),n("span",qe,b(e.date),1)]),_:2},1024),m(v,{title:e.payee,label:e.narration&&e.narration!=="/"?e.narration:"",border:!1},null,8,["title","label"]),(f(!0),F(W,null,O(e.accounts,(l,w)=>(f(),D(v,{key:w,border:!1,clickable:"",onClick:E=>x(l.account)},{title:h(()=>[n("span",Ge,b(l.isFIXME?"âš ï¸ ":"")+b(l.account),1)]),value:h(()=>[n("span",{class:ye(["font-mono",parseFloat(l.amount)<0?"negative":"positive"])},b(l.amount),3)]),_:2},1032,["onClick"]))),128))]),_:2},1024))),128))])])):V("",!0),p.value.length>0?(f(),F("div",Ze,[u[7]||(u[7]=n("h4",{class:"text-sm font-semibold mb-3"},"ä¼˜åŒ–å»ºè®®",-1)),n("div",Je,[(f(!0),F(W,null,O(p.value,(e,g)=>(f(),F("div",{key:g,class:"suggestion-card"},[u[6]||(u[6]=n("span",{class:"suggestion-icon","aria-hidden":"true"},"ğŸ’¡",-1)),n("span",Ke,b(e),1)]))),128))])])):V("",!0),_.value===0&&d.value>0?(f(),D(t,{key:2,description:"æ‰€æœ‰è´¦å•éƒ½å·²æˆåŠŸåŒ¹é…è§„åˆ™",class:"py-6"})):V("",!0)]),_:1})}}}),He=K(Ye,[["__scopeId","data-v-d22b1199"]]),Qe={class:"page-bill"},et={class:"card mb-6"},tt={class:"flex items-center justify-between mb-4"},st={key:1,class:"p-4 rounded-md text-secondary text-sm"},at={key:0,class:"card mb-6"},ot={key:1,class:"card mb-6"},lt={key:2,class:"mb-6 flex flex-wrap gap-3"},nt={key:4,class:"card mb-6"},rt={class:"flex items-center justify-between mb-4"},it={class:"flex gap-2"},ut={class:"mb-4 p-3 rounded-lg bg-gray-1 text-sm grid grid-cols-1 md:grid-cols-3 gap-4"},ct={class:"ml-2 font-medium"},dt={class:"ml-2 font-medium"},vt={class:"ml-2 font-medium"},mt={class:"result-pre"},pt=U({__name:"DegBillProcessingView",setup(i){const S=be(),y=we(),s=H(),o=Ae(),{sharedProvider:d,setSharedProvider:_}=ue(),C=A(!0),c=P(()=>s.currentProvider.value),k=P(()=>{const t=s.supportedProviders.value;return t.length===0?J.filter(e=>["alipay","wechat","icbc","ccb","citic","cmb","huobi","htsec","hxsec","mt","jd","bmo","td","hsbchk"].includes(e.type)):t.map(e=>J.find(l=>l.type===e)).filter(e=>e!==void 0)}),M=P(()=>o.selectedFile.value),$=P(()=>o.isProcessing.value),p=P(()=>o.processingResult.value),x=P(()=>o.error.value||s.error.value),a=P({get:()=>o.outputFormat.value,set:t=>{o.outputFormat.value=t}}),u=async t=>{try{console.log(`[BillProcessing] å¼€å§‹åˆ‡æ¢ provider åˆ°: ${t}`),console.log(`[BillProcessing] ç¬¬ä¸€æ¬¡è°ƒç”¨ setProvider: ${t}`);const e=await s.setProvider(t);console.log("[BillProcessing] setProvider ç»“æœ:",e),await new Promise(l=>setTimeout(l,100));let g=I.getConfig(t);if(g||(g=I.getDefaultConfig(t)),g)try{console.log(`[BillProcessing] ç¬¬äºŒæ¬¡è°ƒç”¨ setProvider: ${t}`);const l=await s.setProvider(t);console.log("[BillProcessing] setProvider ç»“æœ:",l),await new Promise(w=>setTimeout(w,100)),console.log(`[BillProcessing] è°ƒç”¨ updateConfigï¼Œprovider: ${t}`),await s.updateConfig(L.parse(g),t),console.log("[BillProcessing] updateConfig å®Œæˆ")}catch(l){console.warn("åŠ è½½é…ç½®å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®:",l);const w=l instanceof Error?l.message:String(l);(w.includes("expected a map, got")||w.includes("expected a map"))&&I.removeConfig(t),await s.setProvider(t),await new Promise(j=>setTimeout(j,100));const E=I.getDefaultConfig(t);await s.updateConfig(L.parse(E),t)}else console.log("[BillProcessing] æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œåªè®¾ç½® provider");_(t),console.log(`[BillProcessing] provider åˆ‡æ¢å®Œæˆ: ${t}`)}catch(e){console.error("è®¾ç½® Provider å¤±è´¥:",e),o.error.value=`è®¾ç½® Provider å¤±è´¥: ${e instanceof Error?e.message:String(e)}`}},r=t=>{o.selectedFile.value=t,o.error.value=null,t||(o.processingResult.value=null)},v=async()=>{if(!M.value||!c.value){o.error.value="è¯·é€‰æ‹©æ–‡ä»¶å’Œè§£æå™¨";return}console.log(`[BillProcessing] å¼€å§‹å¤„ç†æ–‡ä»¶ï¼Œå½“å‰ provider: ${c.value}`),await o.processFile(M.value,a.value)},T=async()=>{var t;if((t=p.value)!=null&&t.output){const e=await o.copyToClipboard(p.value.output);alert(e?"å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼":"å¤åˆ¶å¤±è´¥")}},B=()=>{const t=a.value==="beancount"?"beancount":"ledger";o.downloadResult(`output.${t}`)},z=()=>{c.value?S.push({path:"/rule-config",query:{provider:c.value,from:"bill-processing"}}):S.push({path:"/rule-config",query:{from:"bill-processing"}})};return _e(async()=>{try{await s.init(),await new Promise(l=>setTimeout(l,200));const t=y.query.provider,e=k.value,g=t&&e.some(l=>l.type===t)?t:d.value&&e.some(l=>l.type===d.value)?d.value:null;if(g)await s.setProvider(g),_(g);else if(e.length>0){const l=e[0].type;await s.setProvider(l),_(l)}if(c.value){await s.setProvider(c.value),await new Promise(w=>setTimeout(w,50));let l=I.getConfig(c.value);if(l||(l=I.getDefaultConfig(c.value)),l)try{await s.updateConfig(L.parse(l),c.value),await s.setProvider(c.value),await new Promise(w=>setTimeout(w,50))}catch(w){console.warn("åŠ è½½é…ç½®å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®:",w);const E=w instanceof Error?w.message:String(w);(E.includes("expected a map, got")||E.includes("expected a map"))&&I.removeConfig(c.value),await s.setProvider(c.value),await new Promise(N=>setTimeout(N,50));const j=I.getDefaultConfig(c.value);await s.updateConfig(L.parse(j),c.value),await s.setProvider(c.value),await new Promise(N=>setTimeout(N,50))}}}catch(t){console.error("åˆå§‹åŒ–å¤±è´¥:",t);const e=t instanceof Error?t.message:String(t);o.error.value=`WASM åˆå§‹åŒ–å¤±è´¥: ${e}ã€‚è¯·åˆ·æ–°é¡µé¢é‡è¯•`}finally{C.value=!1}}),(t,e)=>{const g=Y,l=Me,w=Fe,E=ce;return f(),F("div",Qe,[n("div",et,[n("div",tt,[e[2]||(e[2]=n("h2",{class:"card-title"},"é€‰æ‹©è§£æå™¨",-1)),c.value?(f(),D(g,{key:0,size:"small",onClick:z,title:"è·³è½¬åˆ°è§„åˆ™é…ç½®é¡µé¢"},{default:h(()=>[...e[1]||(e[1]=[R(" é…ç½®è§„åˆ™ ",-1)])]),_:1})):V("",!0)]),k.value.length>0?(f(),D(ge,{key:0,"supported-providers":k.value,"selected-provider":c.value,onProviderSelected:u},null,8,["supported-providers","selected-provider"])):(f(),F("div",st,"æ­£åœ¨åŠ è½½è§£æå™¨åˆ—è¡¨..."))]),c.value?(f(),F("div",at,[e[3]||(e[3]=n("h2",{class:"card-title mb-4"},"ä¸Šä¼ è´¦å•æ–‡ä»¶",-1)),m(me,{"selected-file":M.value,"detected-provider":null,onFileSelected:r},null,8,["selected-file"])])):V("",!0),c.value?(f(),F("div",ot,[e[6]||(e[6]=n("h2",{class:"card-title mb-4"},"è¾“å‡ºæ ¼å¼",-1)),m(w,{modelValue:a.value,"onUpdate:modelValue":e[0]||(e[0]=j=>a.value=j),direction:"horizontal"},{default:h(()=>[m(l,{name:"beancount"},{default:h(()=>[...e[4]||(e[4]=[R("Beancount",-1)])]),_:1}),m(l,{name:"ledger"},{default:h(()=>[...e[5]||(e[5]=[R("Ledger",-1)])]),_:1})]),_:1},8,["modelValue"])])):V("",!0),M.value&&c.value?(f(),F("div",lt,[m(g,{type:"primary",size:"large",loading:$.value,disabled:!M.value,onClick:v},{default:h(()=>[R(b($.value?"å¤„ç†ä¸­...":`ç”Ÿæˆ ${a.value==="beancount"?"Beancount":"Ledger"}`),1)]),_:1},8,["loading","disabled"]),m(g,{size:"large",onClick:z},{default:h(()=>[...e[7]||(e[7]=[R("è§„åˆ™é…ç½®",-1)])]),_:1})])):V("",!0),x.value?(f(),D(E,{key:3,type:"danger","left-icon":"warning-o",class:"mb-6"},{default:h(()=>[R(b(x.value),1)]),_:1})):V("",!0),p.value&&p.value.success?(f(),F("div",nt,[n("div",rt,[e[10]||(e[10]=n("h2",{class:"card-title"},"å¤„ç†ç»“æœ",-1)),n("div",it,[m(g,{size:"small",onClick:T},{default:h(()=>[...e[8]||(e[8]=[R("å¤åˆ¶",-1)])]),_:1}),m(g,{type:"primary",size:"small",onClick:B},{default:h(()=>[...e[9]||(e[9]=[R("ä¸‹è½½",-1)])]),_:1})])]),n("div",ut,[n("div",null,[e[11]||(e[11]=n("span",{class:"text-secondary"},"æ ¼å¼:",-1)),n("span",ct,b(p.value.format||a.value),1)]),n("div",null,[e[12]||(e[12]=n("span",{class:"text-secondary"},"äº¤æ˜“æ•°:",-1)),n("span",dt,b(p.value.transactions||0),1)]),n("div",null,[e[13]||(e[13]=n("span",{class:"text-secondary"},"Provider:",-1)),n("span",vt,b(p.value.provider),1)])]),n("pre",mt,b(p.value.output),1)])):V("",!0),p.value&&p.value.success&&p.value.output?(f(),D(He,{key:5,"processed-data":p.value.output,"total-records":p.value.transactions||0},null,8,["processed-data","total-records"])):V("",!0),C.value?(f(),D(E,{key:6,type:"primary","left-icon":"info-o",class:"mb-6"},{default:h(()=>[...e[14]||(e[14]=[R(" æ­£åœ¨åˆå§‹åŒ– WASM æ¨¡å—... ",-1)])]),_:1})):V("",!0)])}}}),St=K(pt,[["__scopeId","data-v-737af13a"]]);export{St as default};
