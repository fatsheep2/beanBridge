name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: |
          # ä¸ºæœ¬åœ°ç¦»çº¿ç‰ˆæœ¬æ„å»ºï¼ˆä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰
          pnpm run build
          # ä¸ºGitHub Pagesæ„å»ºï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
          VITE_DEPLOY=github BASE_PATH=/beanBridge/ pnpm run build:github
        env:
          VITE_DEPLOY: github

      - name: Create dist.zip
        run: |
          cd dist
          zip -r ../dist.zip .
          cd ..
          ls -la dist.zip

      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="v$(date +'%Y%m%d-%H%M%S')"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist.zip
          tag_name: ${{ steps.get_version.outputs.version }}
          name: BeanBridge ${{ steps.get_version.outputs.version }}
          body: |
            ## BeanBridge ${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¦ ç¦»çº¿ç‰ˆæœ¬
            è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¦»çº¿ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶ã€‚
            
            ### ğŸ”’ éšç§å®‰å…¨
            å»ºè®®ä¸‹è½½ç¦»çº¿ç‰ˆæœ¬ä½¿ç”¨ï¼Œä¿æŠ¤æ‚¨çš„è´¢åŠ¡éšç§ã€‚
            
            ### ğŸ“‹ ä½¿ç”¨è¯´æ˜
            1. ä¸‹è½½ `dist.zip` æ–‡ä»¶
            2. è§£å‹åˆ°æœ¬åœ°ç›®å½•
            3. **è¯·ä½¿ç”¨æœ¬åœ°é™æ€æœåŠ¡å™¨è®¿é—® `index.html`ï¼Œä¸è¦ç›´æ¥åŒå‡»æ‰“å¼€ï¼**
               - æ¨èå‘½ä»¤ï¼š
                 - `pnpm preview`ï¼ˆéœ€å…¨å±€å®‰è£… pnpmï¼‰
                 - `npx serve dist`
                 - `python -m http.server 8080`ï¼ˆéœ€å®‰è£… Pythonï¼‰
               - ç„¶ååœ¨æµè§ˆå™¨è®¿é—® `http://localhost:ç«¯å£å·`
            
            ### ğŸš€ åŠŸèƒ½ç‰¹æ€§
            - æ”¯æŒå¤šç§æ”¯ä»˜å¹³å°ï¼ˆæ”¯ä»˜å®ã€å¾®ä¿¡ç­‰ï¼‰
            - æ™ºèƒ½è§„åˆ™åŒ¹é…
            - æœ¬åœ°å¤„ç†ï¼Œä¿æŠ¤éšç§
            - å“åº”å¼è®¾è®¡
            
            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [åœ¨çº¿ç‰ˆæœ¬](https://1677883418.github.io/beanBridge/)
            - [é¡¹ç›®æºç ](https://github.com/1677883418/beanBridge)
            - [double-entry-generator](https://github.com/deb-sig/double-entry-generator)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 