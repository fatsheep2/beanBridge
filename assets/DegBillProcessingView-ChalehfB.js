import{r as C,d as E,i as f,j as N,u as q,c,a as t,b as y,g as z,w as H,e as k,h as I,k as O,l as S,v as $,t as h,f as W,m as G,o as u}from"./vendor-BLEgdA3F.js";import{u as D,y as P,a as j}from"./useDegWasm-DQyVAUzf.js";import"./wasm-CActu_x9.js";import{p as V,_ as J}from"./ProviderSelector.vue_vue_type_script_setup_true_lang-DjdbX_cx.js";import{_ as K}from"./FileUploadSection.vue_vue_type_script_setup_true_lang-Cf_yA3ta.js";function Q(){const m=D(),_=C(null),x=C(!1),o=C(null),s=C(null),B=C("beancount"),l=async(g,a="beancount")=>{if(!m.currentProvider.value){s.value="请先选择解析器";return}x.value=!0,s.value=null,o.value=null;try{m.isInitialized.value||await m.init(),console.log(`[useDegFileProcessing] 处理文件，当前 provider: ${m.currentProvider.value}`),await m.setProvider(m.currentProvider.value),await new Promise(p=>setTimeout(p,150));const d=await m.processFile(g,a);d.success?(o.value=d,s.value=null):(s.value=d.error||"处理文件失败",o.value=null)}catch(d){console.error("文件处理失败:",d),s.value=d instanceof Error?d.message:"处理文件失败",o.value=null}finally{x.value=!1}};return{selectedFile:_,isProcessing:x,processingResult:o,error:s,outputFormat:B,processFile:l,previewFile:async g=>{await l(g,B.value)},reset:()=>{_.value=null,o.value=null,s.value=null,x.value=!1},downloadResult:g=>{var M;if(!((M=o.value)!=null&&M.output)){s.value="没有可下载的数据";return}const a=new Blob([o.value.output],{type:"text/plain"}),d=URL.createObjectURL(a),p=document.createElement("a");p.href=d,p.download=g||`beancount_${new Date().toISOString().split("T")[0]}.beancount`,document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(d)},copyToClipboard:async g=>{try{return await navigator.clipboard.writeText(g),!0}catch(a){return console.error("复制失败:",a),!1}}}}const X={class:"w-full min-h-screen bg-gray-50 dark:bg-gray-900 px-6 sm:px-12 lg:px-24 py-8"},Y={class:"flex items-center justify-between mb-8"},Z={class:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6"},ee={class:"flex items-center justify-between mb-4"},te={key:1,class:"p-4 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-700"},re={key:0,class:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6"},oe={key:1,class:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6"},se={class:"flex gap-6"},le={class:"flex items-center gap-2 cursor-pointer"},ae={class:"flex items-center gap-2 cursor-pointer"},ne={key:2,class:"mb-6"},ie={class:"flex flex-wrap gap-4"},de=["disabled"],ue={key:0,class:"w-7 h-7 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},ce={key:1,class:"w-7 h-7 mr-3 animate-spin",fill:"none",viewBox:"0 0 24 24"},ge={key:3,class:"mb-6 p-4 bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800 rounded-lg"},ve={class:"flex items-center"},pe={class:"text-red-800 dark:text-red-200 font-medium"},me={key:4,class:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6"},be={class:"mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"},fe={class:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"},ye={class:"ml-2 font-medium text-gray-900 dark:text-white"},xe={class:"ml-2 font-medium text-gray-900 dark:text-white"},we={class:"ml-2 font-medium text-gray-900 dark:text-white"},ke={class:"bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-sm overflow-x-auto max-h-96 overflow-y-auto font-mono text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-700"},he={key:5,class:"mb-6 p-4 bg-blue-50 dark:bg-blue-900/10 border border-blue-200 dark:border-blue-800 rounded-lg"},Re=E({__name:"DegBillProcessingView",setup(m){const _=G(),x=q(),o=D(),s=Q(),B=C(!0),l=f(()=>o.currentProvider.value),F=f(()=>{const r=o.supportedProviders.value;return r.length===0?V.filter(e=>["alipay","wechat","icbc","ccb","citic","cmb","huobi","htsec","hxsec","mt","jd","bmo","td","hsbchk"].includes(e.type)):r.map(e=>V.find(i=>i.type===e)).filter(e=>e!==void 0)}),w=f(()=>s.selectedFile.value),R=f(()=>s.isProcessing.value),v=f(()=>s.processingResult.value),g=f(()=>s.error.value||o.error.value),a=f({get:()=>s.outputFormat.value,set:r=>{s.outputFormat.value=r}}),d=async r=>{try{console.log(`[BillProcessing] 开始切换 provider 到: ${r}`),console.log(`[BillProcessing] 第一次调用 setProvider: ${r}`);const e=await o.setProvider(r);console.log("[BillProcessing] setProvider 结果:",e),await new Promise(i=>setTimeout(i,100));let n=P.getConfig(r);if(n||(n=P.getDefaultConfig(r)),n)try{console.log(`[BillProcessing] 第二次调用 setProvider: ${r}`);const i=await o.setProvider(r);console.log("[BillProcessing] setProvider 结果:",i),await new Promise(b=>setTimeout(b,100)),console.log(`[BillProcessing] 调用 updateConfig，provider: ${r}`),await o.updateConfig(j.parse(n),r),console.log("[BillProcessing] updateConfig 完成")}catch(i){console.warn("加载配置失败，将使用默认配置:",i),await o.setProvider(r),await new Promise(A=>setTimeout(A,100));const b=P.getDefaultConfig(r);await o.updateConfig(j.parse(b),r)}else console.log("[BillProcessing] 没有配置文件，只设置 provider");console.log(`[BillProcessing] provider 切换完成: ${r}`)}catch(e){console.error("设置 Provider 失败:",e),s.error.value=`设置 Provider 失败: ${e instanceof Error?e.message:String(e)}`}},p=r=>{s.selectedFile.value=r,s.error.value=null,r||(s.processingResult.value=null)},M=async()=>{if(!w.value||!l.value){s.error.value="请选择文件和解析器";return}console.log(`[BillProcessing] 开始处理文件，当前 provider: ${l.value}`),await s.processFile(w.value,a.value)},L=async()=>{var r;if((r=v.value)!=null&&r.output){const e=await s.copyToClipboard(v.value.output);alert(e?"已复制到剪贴板！":"复制失败")}},U=()=>{const r=a.value==="beancount"?"beancount":"ledger";s.downloadResult(`output.${r}`)},T=()=>{l.value?_.push({path:"/rule-config",query:{provider:l.value,from:"bill-processing"}}):_.push({path:"/rule-config",query:{from:"bill-processing"}})};return N(async()=>{try{await o.init(),await new Promise(e=>setTimeout(e,200));const r=x.query.provider;if(r?await o.setProvider(r):o.supportedProviders.value.length>0?await o.setProvider(o.supportedProviders.value[0]):F.value.length>0&&await o.setProvider(F.value[0].type),l.value){await o.setProvider(l.value),await new Promise(n=>setTimeout(n,50));let e=P.getConfig(l.value);if(e||(e=P.getDefaultConfig(l.value)),e)try{await o.updateConfig(j.parse(e),l.value),await o.setProvider(l.value),await new Promise(n=>setTimeout(n,50))}catch(n){console.warn("加载配置失败，将使用默认配置:",n),await o.setProvider(l.value),await new Promise(b=>setTimeout(b,50));const i=P.getDefaultConfig(l.value);await o.updateConfig(j.parse(i),l.value),await o.setProvider(l.value),await new Promise(b=>setTimeout(b,50))}}}catch(r){console.error("初始化失败:",r);const e=r instanceof Error?r.message:String(r);s.error.value=`WASM 初始化失败: ${e}。请刷新页面重试`}finally{B.value=!1}}),(r,e)=>{const n=I("router-link");return u(),c("div",X,[t("div",Y,[e[3]||(e[3]=t("h1",{class:"text-3xl font-bold text-gray-900 dark:text-white"},"账单处理",-1)),z(n,{to:"/",class:"inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:text-gray-900 dark:hover:text-white transition-colors"},{default:H(()=>e[2]||(e[2]=[t("svg",{class:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10 19l-7-7m0 0l7-7m-7 7h18"})],-1),k(" 返回首页 ")])),_:1,__:[2]})]),t("div",Z,[t("div",ee,[e[5]||(e[5]=t("h2",{class:"text-lg font-semibold text-gray-900 dark:text-white"},"选择解析器",-1)),l.value?(u(),c("button",{key:0,onClick:T,class:"inline-flex items-center px-3 py-1.5 text-sm font-medium text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-md transition-colors",title:"跳转到规则配置页面"},e[4]||(e[4]=[t("svg",{class:"w-4 h-4 mr-1.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1),k(" 配置规则 ")]))):y("",!0)]),F.value.length>0?(u(),O(J,{key:0,"supported-providers":F.value,"selected-provider":l.value,onProviderSelected:d},null,8,["supported-providers","selected-provider"])):(u(),c("div",te,e[6]||(e[6]=[t("p",{class:"text-gray-600 dark:text-gray-400 text-sm"},"正在加载解析器列表...",-1)])))]),l.value?(u(),c("div",re,[e[7]||(e[7]=t("h2",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-4"},"上传账单文件",-1)),z(K,{"selected-file":w.value,"detected-provider":null,onFileSelected:p},null,8,["selected-file"])])):y("",!0),l.value?(u(),c("div",oe,[e[10]||(e[10]=t("h2",{class:"text-lg font-semibold text-gray-900 dark:text-white mb-4"},"输出格式",-1)),t("div",se,[t("label",le,[S(t("input",{type:"radio","onUpdate:modelValue":e[0]||(e[0]=i=>a.value=i),value:"beancount",class:"w-4 h-4 text-blue-600 focus:ring-blue-500"},null,512),[[$,a.value]]),e[8]||(e[8]=t("span",{class:"text-gray-700 dark:text-gray-300"},"Beancount",-1))]),t("label",ae,[S(t("input",{type:"radio","onUpdate:modelValue":e[1]||(e[1]=i=>a.value=i),value:"ledger",class:"w-4 h-4 text-blue-600 focus:ring-blue-500"},null,512),[[$,a.value]]),e[9]||(e[9]=t("span",{class:"text-gray-700 dark:text-gray-300"},"Ledger",-1))])])])):y("",!0),w.value&&l.value?(u(),c("div",ne,[t("div",ie,[t("button",{onClick:M,disabled:R.value||!w.value,class:"inline-flex items-center px-12 py-5 text-xl font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-2xl shadow-xl transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-blue-600"},[R.value?(u(),c("svg",ce,e[12]||(e[12]=[t("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),t("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):(u(),c("svg",ue,e[11]||(e[11]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"},null,-1),t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"},null,-1)]))),k(" "+h(R.value?"处理中...":`生成 ${a.value==="beancount"?"Beancount":"Ledger"}`),1)],8,de),t("button",{onClick:T,class:"inline-flex items-center px-12 py-5 text-xl font-bold bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-gray-400 dark:hover:border-gray-500 rounded-2xl shadow-xl transition-all duration-200"},e[13]||(e[13]=[t("svg",{class:"w-7 h-7 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})],-1),k(" 规则配置 ")]))])])):y("",!0),g.value?(u(),c("div",ge,[t("div",ve,[e[14]||(e[14]=t("svg",{class:"w-5 h-5 text-red-600 dark:text-red-400 mr-2 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})],-1)),t("span",pe,h(g.value),1)])])):y("",!0),v.value&&v.value.success?(u(),c("div",me,[t("div",{class:"flex items-center justify-between mb-4"},[e[17]||(e[17]=t("h2",{class:"text-lg font-semibold text-gray-900 dark:text-white"},"处理结果",-1)),t("div",{class:"flex gap-2"},[t("button",{onClick:L,class:"inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"},e[15]||(e[15]=[t("svg",{class:"w-4 h-4 mr-1.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1),k(" 复制 ")])),t("button",{onClick:U,class:"inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors"},e[16]||(e[16]=[t("svg",{class:"w-4 h-4 mr-1.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})],-1),k(" 下载 ")]))])]),t("div",be,[t("div",fe,[t("div",null,[e[18]||(e[18]=t("span",{class:"text-gray-600 dark:text-gray-400"},"格式:",-1)),t("span",ye,h(v.value.format||a.value),1)]),t("div",null,[e[19]||(e[19]=t("span",{class:"text-gray-600 dark:text-gray-400"},"交易数:",-1)),t("span",xe,h(v.value.transactions||0),1)]),t("div",null,[e[20]||(e[20]=t("span",{class:"text-gray-600 dark:text-gray-400"},"Provider:",-1)),t("span",we,h(v.value.provider),1)])])]),t("pre",ke,h(v.value.output),1)])):y("",!0),B.value?(u(),c("div",he,e[21]||(e[21]=[W('<div class="flex items-center"><svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="text-blue-800 dark:text-blue-200 font-medium">正在初始化 WASM 模块...</span></div>',1)]))):y("",!0)])}}});export{Re as default};
