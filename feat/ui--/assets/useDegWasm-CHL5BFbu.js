var A=Object.defineProperty;var M=(o,e,r)=>e in o?A(o,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[e]=r;var S=(o,e,r)=>M(o,typeof e!="symbol"?e+"":e,r);import{m as I,r as y}from"./vendor-Cd-K7c-U.js";import{s as F,p as W}from"./wasm-CActu_x9.js";const v=class v{constructor(){S(this,"isInitialized",!1);S(this,"initPromise",null)}static getInstance(){return v.instance||(v.instance=new v),v.instance}async init(){if(!this.isInitialized)return this.initPromise?this.initPromise:(this.initPromise=this._doInit(),this.initPromise)}async _doInit(){try{const r="/beanBridge/feat/ui--/wasm/";console.log("[WASM] 使用路径:",r);const t=await fetch(`${r}wasm_exec.js`,{method:"HEAD"}).catch(()=>null);if(!t||!t.ok)throw new Error("WASM 文件未找到。请确保已运行 `npm run copy-wasm` 或 `pnpm run copy-wasm` 复制 WASM 文件到 public/wasm/ 目录");window.Go||await this.loadScript(`${r}wasm_exec.js`);const s=await fetch(`${r}double-entry-generator.wasm`,{method:"HEAD"}).catch(()=>null);if(!s||!s.ok)throw new Error("WASM 二进制文件未找到。请确保已构建 double-entry-generator 的 WASM 版本");const l=new window.Go,d=await fetch(`${r}double-entry-generator.wasm`);if(!d.ok)throw new Error(`无法加载 WASM 文件: ${d.statusText}`);const f=await WebAssembly.instantiateStreaming(d,l.importObject);l.run(f.instance),await new Promise(i=>setTimeout(i,100)),this.isInitialized=!0,console.log("[WASM] 初始化成功")}catch(e){throw console.error("[WASM] 初始化失败:",e),new Error(`WASM 初始化失败: ${e instanceof Error?e.message:String(e)}`)}}loadScript(e){return new Promise((r,t)=>{if(document.querySelector(`script[src="${e}"]`)){r();return}const s=document.createElement("script");s.src=e,s.onload=()=>r(),s.onerror=l=>t(new Error(`Failed to load script: ${e}`)),document.head.appendChild(s)})}async processFileFromInput(e="fileInput",r="beancount"){if(await this.init(),!window.processFileFromInputWithFormat)throw new Error("WASM 函数未加载");try{const t=await window.processFileFromInputWithFormat(e,r);if(t&&typeof t=="object"){const s=t;return s.error?(console.error("[WASM] 处理文件返回错误:",s.error),{success:!1,error:s.error,output:s.output}):s}return t}catch(t){console.error("[WASM] 处理文件失败:",t);const s=t instanceof Error?t.message:String(t);return s.includes("defaultCommissionAccount")||s.includes("commission")?{success:!1,error:"配置错误: 检测到有手续费交易，但配置文件中缺少 defaultCommissionAccount。请在配置文件中添加 defaultCommissionAccount 字段。"}:{success:!1,error:`处理文件失败: ${s}`}}}async processFile(e,r="beancount"){await this.init();const t=`temp-file-input-${Date.now()}`,s=document.createElement("input");s.type="file",s.id=t,s.style.display="none",document.body.appendChild(s);try{const l=new DataTransfer;l.items.add(e),s.files=l.files;const d=await this.processFileFromInput(t,r);return document.body.removeChild(s),d}catch(l){throw document.getElementById(t)&&document.body.removeChild(s),l}}async processFileContent(e,r,t="beancount"){await this.init();const s=new Blob([r]),l=new File([s],e);return this.processFile(l,t)}async parseYamlConfig(e,r){if(await this.init(),!window.parseYamlConfig)throw new Error("WASM 函数未加载");try{return r?await window.parseYamlConfig(e,r):await window.parseYamlConfig(e)}catch(t){return console.error("[WASM] 解析配置失败:",t),{success:!1,error:`解析配置失败: ${t}`}}}async setProvider(e){if(await this.init(),!window.setProvider)throw new Error("WASM 函数未加载");try{return await window.setProvider(e)}catch(r){return console.error("[WASM] 设置 Provider 失败:",r),{success:!1,error:`设置 Provider 失败: ${r}`}}}async getSupportedProviders(){if(await this.init(),!window.getSupportedProviders)return{success:!1,error:"WASM 函数未加载"};try{return await window.getSupportedProviders()}catch(e){return console.error("[WASM] 获取 Providers 失败:",e),{success:!1,error:`获取 Providers 失败: ${e}`}}}async getCurrentProvider(){if(await this.init(),!window.getCurrentProvider)return{success:!1,error:"WASM 函数未加载"};try{return await window.getCurrentProvider()}catch(e){return console.error("[WASM] 获取当前 Provider 失败:",e),{success:!1,error:`获取当前 Provider 失败: ${e instanceof Error?e.message:String(e)}`}}}async testFunction(e=1,r=2){if(await this.init(),!window.testFunction)throw new Error("WASM 函数未加载");try{return window.testFunction(e,r)}catch(t){return console.error("[WASM] 测试函数失败:",t),{success:!1,message:`测试函数失败: ${t}`}}}};S(v,"instance",null);let C=v;const h=C.getInstance(),p=y(!1),m=y(!1),u=y(null),g=y("alipay"),w=y([]);function Y(){const o=async()=>{if(!p.value){m.value=!0,u.value=null;try{await h.init(),p.value=!0;const i=await h.getSupportedProviders();i.success&&i.providers?(w.value=i.providers,w.value.length===0&&(w.value=["alipay","wechat","icbc","ccb","citic","cmb","huobi","htsec","hxsec","mt","jd","bmo","td","hsbchk"]),w.value.length>0&&!g.value&&(g.value=w.value[0],await h.setProvider(w.value[0]))):(w.value=["alipay","wechat","icbc","ccb","citic","cmb","huobi","htsec","hxsec","mt","jd","bmo","td","hsbchk"],g.value||(g.value="alipay",await h.setProvider("alipay")));const a=await h.getCurrentProvider();a.success&&a.provider&&(g.value=a.provider)}catch(i){u.value=i instanceof Error?i.message:String(i),console.error("[useWasm] 初始化失败:",i),w.value.length===0&&(w.value=["alipay","wechat","icbc","ccb","citic","cmb","huobi","htsec","hxsec","mt","jd","bmo","td","hsbchk"],g.value="alipay")}finally{m.value=!1}}},e=async(i,a="beancount")=>{p.value||await o(),m.value=!0,u.value=null;try{const n=await h.processFile(i,a);return n.success||(u.value=n.error||"处理文件失败"),n}catch(n){const c=n instanceof Error?n.message:String(n);return u.value=c,{success:!1,error:c}}finally{m.value=!1}},r=async(i,a,n="beancount")=>{p.value||await o(),m.value=!0,u.value=null;try{const c=await h.processFileContent(i,a,n);return c.success||(u.value=c.error||"处理文件失败"),c}catch(c){const P=c instanceof Error?c.message:String(c);return u.value=P,{success:!1,error:P}}finally{m.value=!1}},t=async i=>{p.value||await o(),m.value=!0,u.value=null;try{const a=await h.setProvider(i);return a.success?g.value=i:u.value=a.error||"设置 Provider 失败",a}catch(a){const n=a instanceof Error?a.message:String(a);return u.value=n,{success:!1,error:n}}finally{m.value=!1}},s=async(i,a)=>{p.value||await o(),m.value=!0,u.value=null;try{const n=a||g.value,c=await h.parseYamlConfig(i,n);return c.success||(u.value=c.error||"解析配置失败"),c}catch(n){const c=n instanceof Error?n.message:String(n);return u.value=c,{success:!1,error:c}}finally{m.value=!1}},l={alipay:"支付宝",wechat:"微信",icbc:"工商银行",ccb:"建设银行",citic:"中信银行",hsbchk:"汇丰银行香港",htsec:"海通证券",huobi:"火币",td:"道明银行",bmo:"蒙特利尔银行",mt:"美团",jd:"京东",hxsec:"华西证券"},d=i=>l[i]||i,f=I(()=>w.value.map(i=>({value:i,label:d(i)})));return{isInitialized:p,isLoading:m,error:u,currentProvider:g,supportedProviders:w,providersWithNames:f,init:o,processFile:e,processFileContent:r,setProvider:t,parseYamlConfig:s,getProviderDisplayName:d}}const T={parse(o){return W(o)},stringify(o,e){return F(o,e)}},E=T;class ${constructor(){S(this,"STORAGE_KEY","beancount_yaml_configs");S(this,"HISTORY_KEY","beancount_yaml_config_history")}getConfig(e){try{const r=localStorage.getItem(this.STORAGE_KEY);return r&&JSON.parse(r)[e]||null}catch(r){return console.error("Failed to load YAML config:",r),null}}saveConfig(e,r){try{const t=localStorage.getItem(this.STORAGE_KEY),s=t?JSON.parse(t):{};s[e]=r,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),this.saveToHistory(e,r)}catch(t){console.error("Failed to save YAML config:",t)}}getDefaultConfig(e){const r={defaultMinusAccount:"Assets:FIXME",defaultPlusAccount:"Expenses:FIXME",defaultCommissionAccount:"Expenses:Commission:FIXME",defaultCurrency:"CNY",title:"BeanBridge 财务记录"};return r[e]={rules:[]},E.stringify(r,{indent:2,lineWidth:0,minContentWidth:0})}async loadFromExample(e){try{const t=await fetch(`/beanBridge/feat/ui--/example/${e}/config.yaml`);if(t.ok)return await t.text();const s=`https://raw.githubusercontent.com/deb-sig/double-entry-generator/master/example/${e}/config.yaml`,l=await fetch(s);return l.ok?await l.text():null}catch(r){return console.error("Failed to load example config:",r),null}}validateConfig(e){try{const r=E.parse(e);return!r||typeof r!="object"?{valid:!1,error:"配置必须是对象格式"}:r.defaultMinusAccount?r.defaultPlusAccount?r.defaultCurrency?{valid:!0,config:r}:{valid:!1,error:"缺少必需字段: defaultCurrency"}:{valid:!1,error:"缺少必需字段: defaultPlusAccount"}:{valid:!1,error:"缺少必需字段: defaultMinusAccount"}}catch(r){return{valid:!1,error:r instanceof Error?r.message:"YAML 解析失败"}}}exportConfig(e){return this.getConfig(e)}importConfig(e,r){return this.validateConfig(r).valid?(this.saveConfig(e,r),!0):!1}getHistory(e){try{const r=localStorage.getItem(this.HISTORY_KEY),t=r?JSON.parse(r):[];return e?t.filter(s=>s.provider===e):t}catch(r){return console.error("Failed to load history:",r),[]}}saveToHistory(e,r){try{const t=this.getHistory(),s={id:this.generateId(),provider:e,content:r,createdAt:new Date().toISOString()};t.unshift(s);const l=new Map;for(const f of t)l.has(f.provider)||l.set(f.provider,[]),l.get(f.provider).push(f);const d=[];for(const[,f]of l)d.push(...f.slice(0,5));d.sort((f,i)=>new Date(i.createdAt).getTime()-new Date(f.createdAt).getTime()),localStorage.setItem(this.HISTORY_KEY,JSON.stringify(d))}catch(t){console.error("Failed to save to history:",t)}}applyHistory(e){try{const t=this.getHistory().find(s=>s.id===e);return t?(this.saveConfig(t.provider,t.content),t.content):null}catch(r){return console.error("Failed to apply history:",r),null}}deleteHistory(e){try{const r=this.getHistory(),t=r.filter(s=>s.id!==e);return t.length===r.length?!1:(localStorage.setItem(this.HISTORY_KEY,JSON.stringify(t)),!0)}catch(r){return console.error("Failed to delete history:",r),!1}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}}const O=new $;function N(){const o=Y(),e=y(""),r=y("beancount"),t=async i=>{if(await o.init(),i){e.value=i;const a=await o.parseYamlConfig(i);if(!a.success)throw new Error(a.error||"配置解析失败")}},s=async i=>{const a=await o.setProvider(i);if(!a.success)throw new Error(a.error||"设置 Provider 失败")},l=async(i,a="beancount")=>{o.isInitialized.value||await t();const n=o.currentProvider.value;if(!n)throw new Error("请先选择解析器");return await o.setProvider(n),await new Promise(c=>setTimeout(c,100)),e.value&&(await o.parseYamlConfig(e.value,n),await o.setProvider(n),await new Promise(c=>setTimeout(c,100))),await o.setProvider(n),await new Promise(c=>setTimeout(c,50)),await o.processFile(i,a)},d=async(i,a)=>{const n=a||o.currentProvider.value;if(!n)throw new Error("请先选择解析器");console.log(`[useDegWasm] updateConfig: 设置 provider 为 ${n}`),await o.setProvider(n),await new Promise(b=>setTimeout(b,150));const c=E.stringify(i);e.value=c,console.log(`[useDegWasm] updateConfig: 调用 parseYamlConfig，provider: ${n}`);const P=await o.parseYamlConfig(c,n);if(!P.success)throw new Error(P.error||"配置更新失败");return console.log("[useDegWasm] updateConfig: parseYamlConfig 完成，再次确保 provider 正确"),await o.setProvider(n),await new Promise(b=>setTimeout(b,150)),console.log(`[useDegWasm] updateConfig: 完成，provider = ${n}`),P},f=()=>({defaultMinusAccount:"Assets:FIXME",defaultPlusAccount:"Expenses:FIXME",defaultCommissionAccount:"Expenses:Commission:FIXME",defaultCurrency:"CNY",title:"BeanBridge 财务记录"});return{isInitialized:o.isInitialized,isLoading:o.isLoading,error:o.error,currentProvider:o.currentProvider,supportedProviders:o.supportedProviders,providersWithNames:o.providersWithNames,configYaml:e,outputFormat:r,init:t,setProvider:s,processFile:l,updateConfig:d,getDefaultConfig:f,getProviderDisplayName:o.getProviderDisplayName}}export{E as a,N as u,O as y};
