import{d as L,r as m,m as E,s as M,c as i,a as e,b as _,e as p,t as y,k as I,v as K,o as n,i as O,g as Y,w as G,h as J,q as Q,F as X,j as Z,u as ee,p as te,x as re}from"./vendor-z8y3CHRY.js";import{a as V,u as se,y as g}from"./useDegWasm-4xGUuGjT.js";import{p as F,_ as ae}from"./ProviderSelector.vue_vue_type_script_setup_true_lang-DZ7U_8RF.js";import"./wasm-CActu_x9.js";const oe={class:"yaml-config-editor"},le={key:0,class:"mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg"},ne={class:"flex items-center"},ie={class:"text-red-800 dark:text-red-200 text-sm"},de={key:1,class:"mb-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-lg"},ue={class:"flex items-center"},ce={class:"text-green-800 dark:text-green-200 text-sm"},ve={class:"relative"},ge={key:0,class:"absolute inset-0 flex items-center justify-center bg-white/50 dark:bg-gray-900/50"},me={class:"mt-2 text-xs text-gray-500 dark:text-gray-400"},pe=L({__name:"YamlConfigEditor",props:{modelValue:{},provider:{}},emits:["update:modelValue","validated"],setup(j,{expose:P,emit:C}){const d=j,a=C,o=m(d.modelValue||""),u=m(null),c=m(null),b=m(!1),x=E(()=>o.value.split(`
`).length);M(()=>d.modelValue,s=>{s!==o.value&&(o.value=s)}),M(o,s=>{a("update:modelValue",s),u.value=null,c.value=null});const w=()=>{u.value=null,c.value=null},f=()=>{try{const s=V.parse(o.value);o.value=V.stringify(s,{indent:2,lineWidth:0,minContentWidth:0}),c.value="格式化成功",setTimeout(()=>{c.value=null},2e3)}catch(s){u.value=`格式化失败: ${s instanceof Error?s.message:String(s)}`}},k=()=>{try{const s=V.parse(o.value);if(!s||typeof s!="object")throw new Error("配置必须是对象格式");if(!s.defaultMinusAccount)throw new Error("缺少必需字段: defaultMinusAccount");if(!s.defaultPlusAccount)throw new Error("缺少必需字段: defaultPlusAccount");if(!s.defaultCurrency)throw new Error("缺少必需字段: defaultCurrency");if(d.provider&&s[d.provider]){const l=s[d.provider];if(l.rules&&!Array.isArray(l.rules))throw new Error(`${d.provider}.rules 必须是数组`)}u.value=null,c.value="YAML 配置验证通过",a("validated",!0),setTimeout(()=>{c.value=null},2e3)}catch(s){u.value=`验证失败: ${s instanceof Error?s.message:String(s)}`,a("validated",!1)}};return P({formatYaml:f,validateYaml:k,getContent:()=>o.value,setContent:s=>{o.value=s}}),(s,l)=>(n(),i("div",oe,[e("div",{class:"flex items-center justify-between mb-4"},[l[3]||(l[3]=e("h3",{class:"text-lg font-semibold"},"YAML 配置编辑器",-1)),e("div",{class:"flex space-x-2"},[e("button",{onClick:f,class:"inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium shadow-md transition-all text-sm"},l[1]||(l[1]=[e("span",{class:"material-icons text-sm mr-2"},"format_align_left",-1),p(" 格式化 ")])),e("button",{onClick:k,class:"inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md transition-all text-sm"},l[2]||(l[2]=[e("span",{class:"material-icons text-sm mr-2"},"check_circle",-1),p(" 验证 ")]))])]),u.value?(n(),i("div",le,[e("div",ne,[l[4]||(l[4]=e("span",{class:"material-icons text-red-600 dark:text-red-400 mr-2"},"error",-1)),e("span",ie,y(u.value),1)])])):_("",!0),c.value?(n(),i("div",de,[e("div",ue,[l[5]||(l[5]=e("span",{class:"material-icons text-green-600 dark:text-green-400 mr-2"},"check_circle",-1)),e("span",ce,y(c.value),1)])])):_("",!0),e("div",ve,[I(e("textarea",{"onUpdate:modelValue":l[0]||(l[0]=A=>o.value=A),class:"w-full h-96 p-4 font-mono text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 resize-none",placeholder:"请输入 YAML 配置...",onInput:w},null,544),[[K,o.value]]),b.value?(n(),i("div",ge,l[6]||(l[6]=[e("div",{class:"text-gray-600 dark:text-gray-300"},"加载中...",-1)]))):_("",!0)]),e("div",me," 行数: "+y(x.value)+" | 字符数: "+y(o.value.length),1)]))}}),fe={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},ye={class:"bg-white shadow-2xl rounded-2xl border border-gray-200 dark:bg-gray-800 dark:text-gray-100 dark:border-gray-700 p-10"},be={class:"flex items-center justify-between mb-8"},xe={class:"mb-8"},he={key:1,class:"p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700"},we={key:0,class:"space-y-6"},ke={class:"flex items-center justify-between"},_e={class:"text-xl font-semibold"},Ce={class:"flex space-x-2"},$e=["disabled"],Pe={key:0,class:"material-icons mr-2"},Ae={key:1,class:"material-icons mr-2 animate-spin"},Ve={class:"bg-gray-50 dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 p-8"},Ee={class:"flex flex-wrap justify-end gap-4 pt-6 border-t border-gray-200 dark:border-gray-700"},Me=["disabled"],je=["disabled"],Ye={key:0,class:"material-icons mr-2"},Fe={key:1,class:"material-icons mr-2 animate-spin"},Le=["disabled"],Te={key:1,class:"text-center py-12"},De={key:0,class:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"},He={class:"bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto border border-gray-200 dark:bg-gray-800 dark:border-gray-700"},Ne={class:"flex items-center justify-between mb-6"},Se={class:"space-y-2"},Be=["onClick"],Re={class:"flex items-center justify-between"},qe={class:"font-medium"},We={class:"text-sm text-gray-600 dark:text-gray-300"},ze={class:"flex space-x-2"},Ue=["onClick"],Ie={key:0,class:"text-center py-12 text-gray-500 dark:text-gray-400"},Qe=L({__name:"YamlConfigView",setup(j){const P=te(),C=ee(),d=se(),a=m(null),o=m(""),u=m(!1),c=m(!1),b=m(!1),x=m(!1),w=m(null),f=E(()=>{const t=d.supportedProviders.value;return t.length>0?t.map(r=>F.find(v=>v.type===r)).filter(r=>r!==void 0):F.filter(r=>["alipay","wechat","icbc","ccb","citic","cmb","huobi","htsec","hxsec","mt","jd","bmo","td","hsbchk"].includes(r.type))}),k=E(()=>a.value?g.getHistory(a.value):[]),s=async t=>{a.value=t;try{await d.setProvider(t),l()}catch(r){console.error("设置 Provider 失败:",r)}},l=()=>{if(!a.value)return;const t=g.getConfig(a.value);t?o.value=t:o.value=g.getDefaultConfig(a.value)},A=async()=>{if(a.value){c.value=!0;try{const t=await g.loadFromExample(a.value);t?(o.value=t,w.value&&w.value.validateYaml(),alert("示例配置加载成功！")):alert("无法加载示例配置，请检查网络连接或手动创建配置")}catch(t){console.error("Failed to load example:",t),alert("加载示例配置失败")}finally{c.value=!1}}},T=async()=>{if(!(!a.value||!u.value))try{const t=g.validateConfig(o.value);if(!t.valid){alert(`配置验证失败: ${t.error}`);return}g.saveConfig(a.value,o.value),await d.updateConfig(t.config),alert("配置保存成功！")}catch(t){console.error("Failed to save config:",t),alert("保存配置失败")}},D=()=>{if(!a.value)return;const t=g.exportConfig(a.value);t?navigator.clipboard.writeText(t).then(()=>{alert("配置已复制到剪贴板！")}).catch(()=>{alert("复制失败，请重试")}):alert("没有可导出的配置")},H=async()=>{try{const t=await navigator.clipboard.readText();if(!t){alert("剪贴板为空");return}const r=g.validateConfig(t);if(!r.valid){alert(`配置格式错误: ${r.error}`);return}if(a.value)g.importConfig(a.value,t),o.value=t,alert("配置导入成功！");else{const $=r.config,v=Object.keys($).filter(h=>!["defaultMinusAccount","defaultPlusAccount","defaultCurrency","title","defaultCashAccount","defaultCommissionAccount","defaultPositionAccount","defaultPnlAccount"].includes(h));if(v.length>0){const h=v[0];confirm(`检测到配置为 ${h}，是否使用此解析器？`)&&(await s(h),o.value=t,alert("配置导入成功！"))}else alert("无法从配置中检测到解析器，请先选择解析器")}}catch(t){console.error("Failed to import config:",t),alert("导入配置失败")}},N=async()=>{if(!(!a.value||!u.value)){b.value=!0;try{const t=g.validateConfig(o.value);t.config&&await d.updateConfig(t.config),C.push({path:"/bill-processing",query:{provider:a.value,from:"yaml-config",test:"true"}})}catch(t){console.error("Failed to test config:",t),alert("测试配置失败")}finally{b.value=!1}}},S=()=>{a.value&&C.push({path:"/bill-processing",query:{provider:a.value,from:"yaml-config"}})},B=t=>{const r=g.applyHistory(t);r?(o.value=r,x.value=!1,alert("历史配置应用成功！")):alert("应用历史配置失败")},R=t=>{confirm("确定要删除这个历史记录吗？")&&(g.deleteHistory(t)?(x.value=!1,alert("历史记录删除成功！")):alert("删除失败，请重试"))},q=t=>new Date(t).toLocaleString("zh-CN"),W=t=>{u.value=t},z=t=>d.getProviderDisplayName(t),U=()=>{const t=P.query.provider;t?s(t):f.value.length>0&&!a.value&&s(f.value[0].type)};return M(a,()=>{l()}),O(async()=>{try{await d.init(),await new Promise(t=>setTimeout(t,200)),d.supportedProviders.value.length===0&&console.warn("WASM 未返回支持的 providers，使用默认列表"),U()}catch(t){console.error("初始化失败:",t),f.value.length>0&&!a.value&&s(f.value[0].type)}}),(t,r)=>{const $=J("router-link");return n(),i("div",fe,[e("div",ye,[e("div",be,[r[4]||(r[4]=e("h1",{class:"text-3xl font-extrabold"},"YAML 规则配置",-1)),Y($,{to:"/",class:"inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold shadow-md"},{default:G(()=>r[3]||(r[3]=[e("span",{class:"material-icons mr-3"},"arrow_back",-1),p(" 返回首页 ")])),_:1,__:[3]})]),e("div",xe,[r[6]||(r[6]=e("h2",{class:"text-lg font-semibold mb-4"},"选择解析器",-1)),f.value.length>0?(n(),Q(ae,{key:0,"supported-providers":f.value,"selected-provider":a.value,onProviderSelected:s},null,8,["supported-providers","selected-provider"])):(n(),i("div",he,r[5]||(r[5]=[e("p",{class:"text-gray-600 dark:text-gray-400 text-sm"},"正在加载解析器列表...",-1)])))]),a.value?(n(),i("div",we,[e("div",ke,[e("div",null,[e("h3",_e,y(z(a.value)),1),r[7]||(r[7]=e("p",{class:"text-gray-600 dark:text-gray-300"},"使用 double-entry-generator 的 YAML 配置格式",-1))]),e("div",Ce,[e("button",{onClick:A,class:"inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all",disabled:c.value},[c.value?(n(),i("span",Ae,"refresh")):(n(),i("span",Pe,"file_download")),p(" "+y(c.value?"加载中...":"加载示例配置"),1)],8,$e),e("button",{onClick:r[0]||(r[0]=v=>x.value=!0),class:"inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium shadow-md transition-all"},r[8]||(r[8]=[e("span",{class:"material-icons mr-2"},"history",-1),p(" 历史记录 ")])),e("button",{onClick:D,class:"inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium shadow-md transition-all"},r[9]||(r[9]=[e("span",{class:"material-icons mr-2"},"download",-1),p(" 导出配置 ")])),e("button",{onClick:H,class:"inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md transition-all"},r[10]||(r[10]=[e("span",{class:"material-icons mr-2"},"upload",-1),p(" 导入配置 ")]))])]),e("div",Ve,[Y(pe,{modelValue:o.value,"onUpdate:modelValue":r[1]||(r[1]=v=>o.value=v),provider:a.value,onValidated:W,ref_key:"yamlEditorRef",ref:w},null,8,["modelValue","provider"])]),e("div",Ee,[e("button",{onClick:T,class:"inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all",disabled:!u.value},r[11]||(r[11]=[e("span",{class:"material-icons mr-2"},"save",-1),p(" 保存配置 ")]),8,Me),e("button",{onClick:N,class:"inline-flex items-center px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all",disabled:!u.value||b.value},[b.value?(n(),i("span",Fe,"refresh")):(n(),i("span",Ye,"bug_report")),p(" "+y(b.value?"测试中...":"测试配置"),1)],8,je),e("button",{onClick:S,class:"inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all",disabled:!u.value},r[12]||(r[12]=[e("span",{class:"material-icons mr-2"},"play_arrow",-1),p(" 处理账单 ")]),8,Le)])])):(n(),i("div",Te,r[13]||(r[13]=[e("span",{class:"material-icons text-4xl text-gray-400 dark:text-gray-500 mb-4"},"storage",-1),e("p",{class:"text-gray-600 dark:text-gray-300"},"请先选择一个解析器来配置规则",-1)])))]),x.value?(n(),i("div",De,[e("div",He,[e("div",Ne,[r[15]||(r[15]=e("h3",{class:"text-2xl font-bold"},"历史记录",-1)),e("button",{onClick:r[2]||(r[2]=v=>x.value=!1),class:"text-gray-400 hover:text-gray-600 dark:text-gray-500 text-2xl"},r[14]||(r[14]=[e("span",{class:"material-icons"},"close",-1)]))]),e("div",Se,[(n(!0),i(X,null,Z(k.value,v=>(n(),i("div",{key:v.id,class:"border-2 border-gray-100 dark:border-gray-800 rounded-xl p-4 hover:bg-gray-100 dark:hover:bg-gray-900 cursor-pointer",onClick:h=>B(v.id)},[e("div",Re,[e("div",null,[e("h4",qe,y(v.provider),1),e("p",We,y(q(v.createdAt)),1)]),e("div",ze,[r[17]||(r[17]=e("button",{class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"}," 应用 ",-1)),e("button",{onClick:re(h=>R(v.id),["stop"]),class:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"},r[16]||(r[16]=[e("span",{class:"material-icons text-sm"},"delete",-1)]),8,Ue)])])],8,Be))),128))]),k.value.length===0?(n(),i("div",Ie," 暂无历史记录 ")):_("",!0)])])):_("",!0)])}}});export{Qe as default};
