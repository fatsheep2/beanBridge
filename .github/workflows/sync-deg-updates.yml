name: Sync DEG Updates

on:
  # 每天 UTC 时间 2:00 检查一次（北京时间 10:00）
  schedule:
    - cron: '0 2 * * *'
  # 也可以手动触发
  workflow_dispatch:
  # 当 double-entry-generator 发布新版本时触发（通过 webhook）
  repository_dispatch:
    types: [deg-updated]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-deg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout beanBridge
        uses: actions/checkout@v4
        with:
          path: beanBridge
          fetch-depth: 0

      - name: Checkout sync branch (fixed branch for DEG sync)
        working-directory: beanBridge
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          git fetch origin main "$SYNC_BRANCH" 2>/dev/null || true
          if git show-ref --verify --quiet "refs/remotes/origin/$SYNC_BRANCH"; then
            git checkout "$SYNC_BRANCH"
            git merge --no-edit origin/main || true
          else
            git checkout -b "$SYNC_BRANCH" origin/main
          fi

      - name: Checkout double-entry-generator
        uses: actions/checkout@v4
        with:
          repository: deb-sig/double-entry-generator
          path: double-entry-generator
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build WASM
        working-directory: double-entry-generator
        run: |
          make build-wasm
          ls -lh wasm-dist/

      - name: Copy WASM files
        run: |
          mkdir -p beanBridge/public/wasm
          cp double-entry-generator/wasm-dist/double-entry-generator.wasm beanBridge/public/wasm/
          cp double-entry-generator/wasm-dist/wasm_exec.js beanBridge/public/wasm/
          ls -lh beanBridge/public/wasm/

      - name: Sync example configs
        run: |
          # 同步所有 provider 的示例配置文件
          cd double-entry-generator
          for provider_dir in example/*/; do
            provider=$(basename "$provider_dir")
            if [ -f "$provider_dir/config.yaml" ]; then
              echo "Syncing config for $provider..."
              mkdir -p "../beanBridge/public/example/$provider"
              cp "$provider_dir/config.yaml" "../beanBridge/public/example/$provider/" || true
            fi
          done
          echo "Synced example configs:"
          ls -la ../beanBridge/public/example/

      - name: Check for changes
        id: changes
        working-directory: beanBridge
        run: |
          git add public/wasm/ public/example/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git status
          fi

      - name: Commit and push to fixed sync branch
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beanBridge
        run: |
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          git commit -m "chore(sync-deg): update WASM and example from double-entry-generator

          - Update WASM files from double-entry-generator
          - Sync example configurations
          - Auto-generated by GitHub Actions"
          git push origin HEAD:"$SYNC_BRANCH"

      - name: Create or update Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beanBridge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          gh pr create \
            --title "chore(sync-deg): update WASM and example from DEG" \
            --body "自动从 double-entry-generator 同步：
          - WASM 产物（public/wasm/）
          - 示例配置（public/example/）

          由 GitHub Actions 自动生成。仅当上游有变更时此分支会更新，可与 main 对比后按需合并。" \
            --base main \
            --head "$SYNC_BRANCH" || echo "PR 已存在或创建失败（推送后已有 PR 会自动包含新提交）"

