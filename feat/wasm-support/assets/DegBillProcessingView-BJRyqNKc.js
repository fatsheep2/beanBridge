import{r as _,d as N,m as f,i as I,p as O,c,a as t,b as y,g as D,w as W,h as z,q as A,e as k,k as V,l as j,t as P,u as G,o as d}from"./vendor-z8y3CHRY.js";import{u as U,y as h,a as $}from"./useDegWasm-D6bdL0uE.js";import"./wasm-CActu_x9.js";import{p as L,_ as H}from"./ProviderSelector.vue_vue_type_script_setup_true_lang-DYc7ZliS.js";import{_ as J}from"./FileUploadSection.vue_vue_type_script_setup_true_lang-DaUQz366.js";function K(){const m=U(),C=_(null),x=_(!1),r=_(null),o=_(null),F=_("beancount"),l=async(g,a="beancount")=>{if(!m.currentProvider.value){o.value="请先选择解析器";return}x.value=!0,o.value=null,r.value=null;try{m.isInitialized.value||await m.init(),console.log(`[useDegFileProcessing] 处理文件，当前 provider: ${m.currentProvider.value}`),await m.setProvider(m.currentProvider.value),await new Promise(p=>setTimeout(p,150));const u=await m.processFile(g,a);u.success?(r.value=u,o.value=null):(o.value=u.error||"处理文件失败",r.value=null)}catch(u){console.error("文件处理失败:",u),o.value=u instanceof Error?u.message:"处理文件失败",r.value=null}finally{x.value=!1}};return{selectedFile:C,isProcessing:x,processingResult:r,error:o,outputFormat:F,processFile:l,previewFile:async g=>{await l(g,F.value)},reset:()=>{C.value=null,r.value=null,o.value=null,x.value=!1},downloadResult:g=>{var T;if(!((T=r.value)!=null&&T.output)){o.value="没有可下载的数据";return}const a=new Blob([r.value.output],{type:"text/plain"}),u=URL.createObjectURL(a),p=document.createElement("a");p.href=u,p.download=g||`beancount_${new Date().toISOString().split("T")[0]}.beancount`,document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(u)},copyToClipboard:async g=>{try{return await navigator.clipboard.writeText(g),!0}catch(a){return console.error("复制失败:",a),!1}}}}const Q={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},X={class:"bg-white shadow-2xl rounded-2xl border border-gray-200 dark:bg-gray-800 dark:text-gray-100 dark:border-gray-700 p-10"},Y={class:"flex items-center justify-between mb-8"},Z={class:"mb-8"},ee={class:"flex items-center justify-between mb-4"},te={key:1,class:"p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700"},se={key:0,class:"mb-8"},re={key:1,class:"mb-8 bg-gray-50 dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 p-6"},oe={class:"flex space-x-6"},le={class:"flex items-center space-x-2 cursor-pointer"},ae={class:"flex items-center space-x-2 cursor-pointer"},ie={key:2,class:"mb-8"},ne={class:"flex flex-wrap gap-4"},ue=["disabled"],de={key:0,class:"material-icons mr-2"},ce={key:1,class:"material-icons mr-2 animate-spin"},ge={key:3,class:"mb-8 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg"},ve={class:"flex items-center"},pe={class:"text-red-800 dark:text-red-200 font-medium"},me={key:4,class:"mb-8"},be={class:"bg-gray-50 dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 p-6"},fe={class:"mb-4 p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700"},ye={class:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"},xe={class:"ml-2 font-medium text-gray-900 dark:text-white"},we={class:"ml-2 font-medium text-gray-900 dark:text-white"},ke={class:"ml-2 font-medium text-gray-900 dark:text-white"},Pe={class:"bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 text-sm overflow-x-auto max-h-96 overflow-y-auto font-mono text-gray-900 dark:text-gray-100"},he={key:5,class:"mb-8 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700 rounded-lg"},Te=N({__name:"DegBillProcessingView",setup(m){const C=G(),x=O(),r=U(),o=K(),F=_(!0),l=f(()=>r.currentProvider.value),R=f(()=>{const s=r.supportedProviders.value;return s.length===0?L.filter(e=>["alipay","wechat","icbc","ccb","citic","cmb","huobi","htsec","hxsec","mt","jd","bmo","td","hsbchk"].includes(e.type)):s.map(e=>L.find(n=>n.type===e)).filter(e=>e!==void 0)}),w=f(()=>o.selectedFile.value),B=f(()=>o.isProcessing.value),v=f(()=>o.processingResult.value),g=f(()=>o.error.value||r.error.value),a=f({get:()=>o.outputFormat.value,set:s=>{o.outputFormat.value=s}}),u=async s=>{try{console.log(`[BillProcessing] 开始切换 provider 到: ${s}`),console.log(`[BillProcessing] 第一次调用 setProvider: ${s}`);const e=await r.setProvider(s);console.log("[BillProcessing] setProvider 结果:",e),await new Promise(n=>setTimeout(n,100));let i=h.getConfig(s);if(i||(i=h.getDefaultConfig(s)),i)try{console.log(`[BillProcessing] 第二次调用 setProvider: ${s}`);const n=await r.setProvider(s);console.log("[BillProcessing] setProvider 结果:",n),await new Promise(b=>setTimeout(b,100)),console.log(`[BillProcessing] 调用 updateConfig，provider: ${s}`),await r.updateConfig($.parse(i),s),console.log("[BillProcessing] updateConfig 完成")}catch(n){console.warn("加载配置失败，将使用默认配置:",n),await r.setProvider(s),await new Promise(q=>setTimeout(q,100));const b=h.getDefaultConfig(s);await r.updateConfig($.parse(b),s)}else console.log("[BillProcessing] 没有配置文件，只设置 provider");console.log(`[BillProcessing] provider 切换完成: ${s}`)}catch(e){console.error("设置 Provider 失败:",e),o.error.value=`设置 Provider 失败: ${e instanceof Error?e.message:String(e)}`}},p=s=>{o.selectedFile.value=s,o.error.value=null,s||(o.processingResult.value=null)},T=async()=>{if(!w.value||!l.value){o.error.value="请选择文件和解析器";return}console.log(`[BillProcessing] 开始处理文件，当前 provider: ${l.value}`),await o.processFile(w.value,a.value)},E=async()=>{var s;if((s=v.value)!=null&&s.output){const e=await o.copyToClipboard(v.value.output);alert(e?"已复制到剪贴板！":"复制失败")}},M=()=>{const s=a.value==="beancount"?"beancount":"ledger";o.downloadResult(`output.${s}`)},S=()=>{l.value?C.push({path:"/rule-config",query:{provider:l.value,from:"bill-processing"}}):C.push({path:"/rule-config",query:{from:"bill-processing"}})};return I(async()=>{try{await r.init(),await new Promise(e=>setTimeout(e,200));const s=x.query.provider;if(s?await r.setProvider(s):r.supportedProviders.value.length>0?await r.setProvider(r.supportedProviders.value[0]):R.value.length>0&&await r.setProvider(R.value[0].type),l.value){await r.setProvider(l.value),await new Promise(i=>setTimeout(i,50));let e=h.getConfig(l.value);if(e||(e=h.getDefaultConfig(l.value)),e)try{await r.updateConfig($.parse(e),l.value),await r.setProvider(l.value),await new Promise(i=>setTimeout(i,50))}catch(i){console.warn("加载配置失败，将使用默认配置:",i),await r.setProvider(l.value),await new Promise(b=>setTimeout(b,50));const n=h.getDefaultConfig(l.value);await r.updateConfig($.parse(n),l.value),await r.setProvider(l.value),await new Promise(b=>setTimeout(b,50))}}}catch(s){console.error("初始化失败:",s);const e=s instanceof Error?s.message:String(s);o.error.value=`WASM 初始化失败: ${e}。请刷新页面重试`}finally{F.value=!1}}),(s,e)=>{const i=z("router-link");return d(),c("div",Q,[t("div",X,[t("div",Y,[e[3]||(e[3]=t("h1",{class:"text-3xl font-extrabold"},"账单处理",-1)),D(i,{to:"/",class:"inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold shadow-md"},{default:W(()=>e[2]||(e[2]=[t("span",{class:"material-icons mr-3"},"arrow_back",-1),k(" 返回首页 ")])),_:1,__:[2]})]),t("div",Z,[t("div",ee,[e[5]||(e[5]=t("h2",{class:"text-lg font-semibold"},"选择解析器",-1)),l.value?(d(),c("button",{key:0,onClick:S,class:"inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium shadow-md transition-all text-sm",title:"跳转到规则配置页面"},e[4]||(e[4]=[t("span",{class:"material-icons mr-2 text-sm"},"settings",-1),k(" 配置规则 ")]))):y("",!0)]),R.value.length>0?(d(),A(H,{key:0,"supported-providers":R.value,"selected-provider":l.value,onProviderSelected:u},null,8,["supported-providers","selected-provider"])):(d(),c("div",te,e[6]||(e[6]=[t("p",{class:"text-gray-600 dark:text-gray-400 text-sm"},"正在加载解析器列表...",-1)])))]),l.value?(d(),c("div",se,[e[7]||(e[7]=t("h2",{class:"text-lg font-semibold mb-4"},"上传账单文件",-1)),D(J,{"selected-file":w.value,"detected-provider":null,onFileSelected:p},null,8,["selected-file"])])):y("",!0),l.value?(d(),c("div",re,[e[10]||(e[10]=t("h2",{class:"text-lg font-semibold mb-4"},"输出格式",-1)),t("div",oe,[t("label",le,[V(t("input",{type:"radio","onUpdate:modelValue":e[0]||(e[0]=n=>a.value=n),value:"beancount",class:"w-4 h-4 text-blue-600 focus:ring-blue-500"},null,512),[[j,a.value]]),e[8]||(e[8]=t("span",{class:"text-gray-700 dark:text-gray-300 font-medium"},"Beancount",-1))]),t("label",ae,[V(t("input",{type:"radio","onUpdate:modelValue":e[1]||(e[1]=n=>a.value=n),value:"ledger",class:"w-4 h-4 text-blue-600 focus:ring-blue-500"},null,512),[[j,a.value]]),e[9]||(e[9]=t("span",{class:"text-gray-700 dark:text-gray-300 font-medium"},"Ledger",-1))])])])):y("",!0),w.value&&l.value?(d(),c("div",ie,[t("div",ne,[t("button",{onClick:T,disabled:B.value||!w.value,class:"inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all"},[B.value?(d(),c("span",ce,"refresh")):(d(),c("span",de,"play_arrow")),k(" "+P(B.value?"处理中...":`生成 ${a.value==="beancount"?"Beancount":"Ledger"}`),1)],8,ue),t("button",{onClick:S,class:"inline-flex items-center px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold shadow-md transition-all"},e[11]||(e[11]=[t("span",{class:"material-icons mr-2"},"settings",-1),k(" 规则配置 ")]))])])):y("",!0),g.value?(d(),c("div",ge,[t("div",ve,[e[12]||(e[12]=t("span",{class:"material-icons text-red-600 dark:text-red-400 mr-2"},"error",-1)),t("span",pe,P(g.value),1)])])):y("",!0),v.value&&v.value.success?(d(),c("div",me,[t("div",be,[t("div",{class:"flex items-center justify-between mb-4"},[e[15]||(e[15]=t("h2",{class:"text-xl font-bold text-gray-900 dark:text-white"},"处理结果",-1)),t("div",{class:"flex gap-2"},[t("button",{onClick:E,class:"inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-medium transition-all"},e[13]||(e[13]=[t("span",{class:"material-icons mr-2 text-sm"},"content_copy",-1),k(" 复制 ")])),t("button",{onClick:M,class:"inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-all"},e[14]||(e[14]=[t("span",{class:"material-icons mr-2 text-sm"},"download",-1),k(" 下载 ")]))])]),t("div",fe,[t("div",ye,[t("div",null,[e[16]||(e[16]=t("span",{class:"text-gray-600 dark:text-gray-400"},"格式:",-1)),t("span",xe,P(v.value.format||a.value),1)]),t("div",null,[e[17]||(e[17]=t("span",{class:"text-gray-600 dark:text-gray-400"},"交易数:",-1)),t("span",we,P(v.value.transactions||0),1)]),t("div",null,[e[18]||(e[18]=t("span",{class:"text-gray-600 dark:text-gray-400"},"Provider:",-1)),t("span",ke,P(v.value.provider),1)])])]),t("pre",Pe,P(v.value.output),1)])])):y("",!0),F.value?(d(),c("div",he,e[19]||(e[19]=[t("div",{class:"flex items-center"},[t("span",{class:"material-icons text-blue-600 dark:text-blue-400 mr-2 animate-spin"},"refresh"),t("span",{class:"text-blue-800 dark:text-blue-200 font-medium"},"正在初始化 WASM 模块...")],-1)]))):y("",!0)])])}}});export{Te as default};
