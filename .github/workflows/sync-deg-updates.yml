name: Sync DEG Updates

on:
  # æ¯å¤© UTC æ—¶é—´ 2:00 æ£€æŸ¥ä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  schedule:
    - cron: '0 2 * * *'
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“ double-entry-generator å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶è§¦å‘ï¼ˆé€šè¿‡ webhookï¼‰
  repository_dispatch:
    types: [deg-updated]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-deg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout beanBridge
        uses: actions/checkout@v4
        with:
          path: beanBridge
          fetch-depth: 0

      - name: Checkout sync branch (fixed branch for DEG sync)
        working-directory: beanBridge
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          
          echo "=== Checking sync branch ==="
          git fetch origin main "$SYNC_BRANCH" 2>/dev/null || true
          
          if git show-ref --verify --quiet "refs/remotes/origin/$SYNC_BRANCH"; then
            echo "Branch $SYNC_BRANCH exists, checking out..."
            git checkout "$SYNC_BRANCH"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æœªè§£å†³çš„å†²çª
            if [ -n "$(git ls-files -u)" ]; then
              echo "âš  Unmerged files detected, resolving conflicts..."
              # å¯¹äºŽ workflow æ–‡ä»¶ï¼Œä¼˜å…ˆä½¿ç”¨ main çš„ç‰ˆæœ¬ï¼ˆå› ä¸º workflow æ›´æ–°åº”è¯¥åœ¨ mainï¼‰
              git checkout --theirs .github/workflows/sync-deg-updates.yml 2>/dev/null || true
              git add .github/workflows/sync-deg-updates.yml || true
              # å¯¹äºŽå…¶ä»–æ–‡ä»¶ï¼Œä½¿ç”¨ sync branch çš„ç‰ˆæœ¬
              git checkout --ours public/ 2>/dev/null || true
              git add public/ || true
            fi
            
            echo "=== Merging origin/main ==="
            # ä½¿ç”¨ç­–ç•¥åˆå¹¶ï¼Œä¼˜å…ˆä½¿ç”¨ main çš„ workflowï¼Œsync branch çš„ public æ–‡ä»¶
            git merge --no-edit origin/main -X theirs -X ours || {
              echo "âš  Merge conflict detected, resolving..."
              # å¦‚æžœè¿˜æœ‰å†²çªï¼Œä½¿ç”¨ç­–ç•¥è§£å†³
              git checkout --theirs .github/workflows/ 2>/dev/null || true
              git checkout --ours public/ 2>/dev/null || true
              git add .github/workflows/ public/ 2>/dev/null || true
              # å®Œæˆ merge
              git commit --no-edit || git merge --abort || true
            }
          else
            echo "Branch $SYNC_BRANCH does not exist, creating from main..."
            git checkout -b "$SYNC_BRANCH" origin/main
          fi
          
          echo "âœ“ Sync branch ready: $SYNC_BRANCH"
          git status

      - name: Checkout double-entry-generator
        uses: actions/checkout@v4
        with:
          repository: deb-sig/double-entry-generator
          path: double-entry-generator
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Verify double-entry-generator checkout
        run: |
          echo "=== Checking double-entry-generator directory ==="
          ls -la double-entry-generator/ | head -10
          echo "=== Checking for go.sum ==="
          if [ -f "double-entry-generator/go.sum" ]; then
            echo "âœ“ go.sum found at: double-entry-generator/go.sum"
            ls -lh double-entry-generator/go.sum
          else
            echo "âœ— go.sum NOT found in double-entry-generator/"
            find . -name "go.sum" -type f 2>/dev/null || echo "No go.sum found anywhere"
            exit 1
          fi

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('double-entry-generator/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
        continue-on-error: true

      - name: Download Go dependencies
        working-directory: double-entry-generator
        run: |
          echo "=== Downloading Go dependencies ==="
          go version
          go env GOROOT
          go env GOPATH
          go mod download
          go mod verify
          echo "âœ“ Dependencies downloaded successfully"

      - name: Build WASM
        working-directory: double-entry-generator
        run: |
          echo "=== Building WASM ==="
          echo "Current directory: $(pwd)"
          echo "Go version: $(go version)"
          echo "GOROOT: $(go env GOROOT)"
          
          # æ£€æŸ¥ wasm_exec.js çš„æ­£ç¡®è·¯å¾„
          GOROOT=$(go env GOROOT)
          echo "=== Checking wasm_exec.js location ==="
          if [ -f "$GOROOT/lib/wasm/wasm_exec.js" ]; then
            echo "âœ“ Found wasm_exec.js at: $GOROOT/lib/wasm/wasm_exec.js"
            ls -lh "$GOROOT/lib/wasm/wasm_exec.js"
          elif [ -f "$GOROOT/misc/wasm/wasm_exec.js" ]; then
            echo "âš  Found wasm_exec.js at: $GOROOT/misc/wasm/wasm_exec.js (old location)"
            ls -lh "$GOROOT/misc/wasm/wasm_exec.js"
          else
            echo "âœ— wasm_exec.js NOT found in GOROOT"
            echo "Searching for wasm_exec.js..."
            find "$GOROOT" -name "wasm_exec.js" 2>/dev/null || echo "Not found"
            exit 1
          fi
          
          # Go 1.24 ä¸­ wasm_exec.js åœ¨ lib/wasm/ï¼Œä¿®å¤ Makefile ä¸­çš„è·¯å¾„
          echo "=== Patching Makefile ==="
          if grep -q "misc/wasm/wasm_exec.js" Makefile; then
            echo "Found misc/wasm/wasm_exec.js in Makefile, patching..."
            sed -i.bak 's|misc/wasm/wasm_exec.js|lib/wasm/wasm_exec.js|g' Makefile
            echo "âœ“ Makefile patched"
            grep "wasm_exec.js" Makefile || true
          else
            echo "Makefile already uses correct path or pattern not found"
          fi
          
          echo "=== Running make build-wasm ==="
          make build-wasm
          
          echo "=== Verifying build output ==="
          if [ ! -d "wasm-dist" ]; then
            echo "âœ— wasm-dist directory not created"
            exit 1
          fi
          
          echo "=== Build output files ==="
          ls -lh wasm-dist/
          
          if [ ! -f "wasm-dist/double-entry-generator.wasm" ]; then
            echo "âœ— double-entry-generator.wasm not found"
            exit 1
          fi
          
          if [ ! -f "wasm-dist/wasm_exec.js" ]; then
            echo "âœ— wasm_exec.js not found in wasm-dist, copying from GOROOT"
            GOROOT=$(go env GOROOT)
            if [ -f "$GOROOT/lib/wasm/wasm_exec.js" ]; then
              cp "$GOROOT/lib/wasm/wasm_exec.js" wasm-dist/
              echo "âœ“ Copied wasm_exec.js from $GOROOT/lib/wasm/"
            else
              echo "âœ— Cannot find wasm_exec.js to copy"
              exit 1
            fi
          fi
          
          echo "âœ“ WASM build completed successfully"

      - name: Copy WASM files
        run: |
          echo "=== Copying WASM files ==="
          mkdir -p beanBridge/public/wasm
          
          if [ ! -f "double-entry-generator/wasm-dist/double-entry-generator.wasm" ]; then
            echo "âœ— Source WASM file not found"
            exit 1
          fi
          
          if [ ! -f "double-entry-generator/wasm-dist/wasm_exec.js" ]; then
            echo "âœ— Source wasm_exec.js not found"
            exit 1
          fi
          
          cp double-entry-generator/wasm-dist/double-entry-generator.wasm beanBridge/public/wasm/
          cp double-entry-generator/wasm-dist/wasm_exec.js beanBridge/public/wasm/
          
          echo "=== Copied files ==="
          ls -lh beanBridge/public/wasm/
          
          # éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆWASM æ–‡ä»¶åº”è¯¥ > 0ï¼‰
          WASM_SIZE=$(stat -f%z beanBridge/public/wasm/double-entry-generator.wasm 2>/dev/null || stat -c%s beanBridge/public/wasm/double-entry-generator.wasm 2>/dev/null || echo "0")
          if [ "$WASM_SIZE" -eq 0 ]; then
            echo "âœ— WASM file is empty"
            exit 1
          fi
          echo "âœ“ WASM file size: $WASM_SIZE bytes"

      - name: Sync example configs
        run: |
          # åŒæ­¥æ‰€æœ‰ provider çš„ç¤ºä¾‹é…ç½®æ–‡ä»¶
          cd double-entry-generator
          for provider_dir in example/*/; do
            provider=$(basename "$provider_dir")
            if [ -f "$provider_dir/config.yaml" ]; then
              echo "Syncing config for $provider..."
              mkdir -p "../beanBridge/public/example/$provider"
              cp "$provider_dir/config.yaml" "../beanBridge/public/example/$provider/" || true
            fi
          done
          echo "Synced example configs:"
          ls -la ../beanBridge/public/example/

      - name: Check for changes
        id: changes
        working-directory: beanBridge
        run: |
          echo "=== Checking for changes ==="
          echo "Current branch: $(git branch --show-current)"
          echo "Current status:"
          git status --short || true
          
          # å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "=== Checking if files exist ==="
          if [ ! -d "public/wasm" ] || [ ! -d "public/example" ]; then
            echo "âœ— public/wasm/ or public/example/ directory not found"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # åˆ—å‡ºå½“å‰å·¥ä½œç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          echo "=== Current working directory files ==="
          echo "--- public/wasm/ files ---"
          find public/wasm/ -type f -exec ls -lh {} \; 2>/dev/null || echo "No files found"
          echo ""
          echo "--- public/example/ files ---"
          find public/example/ -type f -exec ls -lh {} \; 2>/dev/null || echo "No files found"
          echo ""
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢« git è·Ÿè¸ª
          echo "=== Checking git tracking status ==="
          WASM_TRACKED=$(git ls-files public/wasm/ 2>/dev/null | wc -l || echo "0")
          EXAMPLE_TRACKED=$(git ls-files public/example/ 2>/dev/null | wc -l || echo "0")
          echo "Tracked files in public/wasm/: $WASM_TRACKED"
          echo "Tracked files in public/example/: $EXAMPLE_TRACKED"
          
          # åˆ—å‡ºæœªè·Ÿè¸ªçš„æ–‡ä»¶
          echo "=== Untracked files ==="
          UNTRACKED=$(git ls-files --others --exclude-standard public/wasm/ public/example/ 2>/dev/null || echo "")
          if [ -n "$UNTRACKED" ]; then
            echo "Found untracked files:"
            echo "$UNTRACKED"
          else
            echo "No untracked files"
          fi
          echo ""
          
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬æœªè·Ÿè¸ªçš„ï¼‰
          echo "=== Staging files (force add) ==="
          git add -f public/wasm/ public/example/ || {
            echo "âš  Failed to stage files"
            ls -la public/ || echo "public/ directory not found"
            exit 1
          }
          
          # å…³é”®æ”¹è¿›ï¼šä¸Ž main åˆ†æ”¯æ¯”è¾ƒï¼Œè€Œä¸æ˜¯ä¸Ž sync branch çš„ HEAD æ¯”è¾ƒ
          # å› ä¸ºæˆ‘ä»¬çš„ç›®æ ‡æ˜¯åŒæ­¥åˆ° mainï¼Œæ‰€ä»¥åº”è¯¥çœ‹ç›¸å¯¹äºŽ main æ˜¯å¦æœ‰å˜åŒ–
          echo "=== Comparing with origin/main (this is what matters) ==="
          
          # æ£€æŸ¥ä¸Ž main åˆ†æ”¯çš„å·®å¼‚ï¼ˆåŒ…æ‹¬æ–°æ–‡ä»¶å’Œä¿®æ”¹çš„æ–‡ä»¶ï¼‰
          MAIN_DIFF_COUNT=0
          MAIN_NEW_FILES=()
          MAIN_MODIFIED_FILES=()
          
          # æ£€æŸ¥æ‰€æœ‰æ–‡ä»¶æ˜¯å¦åœ¨ main ä¸­å­˜åœ¨æˆ–ä¸åŒ
          for file in $(find public/wasm/ public/example/ -type f 2>/dev/null); do
            if ! git cat-file -e "origin/main:$file" 2>/dev/null; then
              # æ–‡ä»¶åœ¨ main ä¸­ä¸å­˜åœ¨ï¼Œæ˜¯æ–°æ–‡ä»¶
              MAIN_NEW_FILES+=("$file")
              MAIN_DIFF_COUNT=$((MAIN_DIFF_COUNT + 1))
              echo "New file (not in main): $file"
            else
              # æ–‡ä»¶åœ¨ main ä¸­å­˜åœ¨ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦ä¸åŒ
              if ! git diff --quiet "origin/main:$file" "$file" 2>/dev/null; then
                MAIN_MODIFIED_FILES+=("$file")
                MAIN_DIFF_COUNT=$((MAIN_DIFF_COUNT + 1))
                echo "Modified file (different from main): $file"
              fi
            fi
          done
          
          echo ""
          echo "=== Summary: Changes vs main ==="
          echo "New files: ${#MAIN_NEW_FILES[@]}"
          echo "Modified files: ${#MAIN_MODIFIED_FILES[@]}"
          echo "Total changes: $MAIN_DIFF_COUNT"
          echo ""
          
          # ä¹Ÿæ£€æŸ¥ä¸Žå½“å‰ HEADï¼ˆsync branchï¼‰çš„å·®å¼‚ï¼Œç”¨äºŽè°ƒè¯•
          echo "=== Debug: Comparing with current HEAD (sync branch) ==="
          STAGED_COUNT=$(git diff --staged --name-only | wc -l || echo "0")
          echo "Staged changes vs HEAD: $STAGED_COUNT files"
          if [ "$STAGED_COUNT" -gt 0 ]; then
            echo "Staged changes:"
            git diff --staged --name-status || true
          fi
          echo ""
          
          # æœ€ç»ˆåˆ¤æ–­ï¼šå¦‚æžœä¸Ž main æœ‰å·®å¼‚ï¼Œåˆ™è®¤ä¸ºæœ‰å˜åŒ–
          if [ "$MAIN_DIFF_COUNT" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Changes detected vs main ($MAIN_DIFF_COUNT files)"
            echo ""
            if [ ${#MAIN_NEW_FILES[@]} -gt 0 ]; then
              echo "New files:"
              printf '  %s\n' "${MAIN_NEW_FILES[@]}"
            fi
            if [ ${#MAIN_MODIFIED_FILES[@]} -gt 0 ]; then
              echo "Modified files:"
              printf '  %s\n' "${MAIN_MODIFIED_FILES[@]}"
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ— No changes detected vs main"
            echo "All files in public/wasm/ and public/example/ are identical to origin/main"
            echo ""
            echo "=== Debug info ==="
            echo "This might mean:"
            echo "1. Sync branch already contains these files (synced previously)"
            echo "2. Main branch already has these files"
            echo "3. Files are identical to main"
          fi
          
          echo ""
          echo "=== Final result ==="
          echo "has_changes value: ${{ steps.changes.outputs.has_changes }}"

      - name: Debug changes output
        if: always()
        working-directory: beanBridge
        run: |
          echo "=== Debug: Changes output ==="
          echo "has_changes from step: ${{ steps.changes.outputs.has_changes }}"
          echo "Checking if PR step will run..."
          if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ“ PR step will run"
          else
            echo "âœ— PR step will be skipped (has_changes=false)"
            echo "This means no changes were detected in public/wasm/ or public/example/"
          fi

      - name: Commit and push to fixed sync branch
        id: commit
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beanBridge
        run: |
          echo "=== Committing changes ==="
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          
          # ç¡®ä¿ git é…ç½®æ­£ç¡®
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "Current branch: $(git branch --show-current)"
          echo "Changes to commit:"
          git status --short
          
          git commit -m "chore(sync-deg): update WASM and example from double-entry-generator

          - Update WASM files from double-entry-generator
          - Sync example configurations
          - Auto-generated by GitHub Actions"
          
          echo "=== Pushing to $SYNC_BRANCH ==="
          # è®¾ç½® remote URL ä½¿ç”¨ token
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # æ˜¾ç¤º remote ä¿¡æ¯ï¼ˆéšè— tokenï¼‰
          echo "Remote URL configured"
          git remote -v | sed 's/x-access-token:[^@]*@/x-access-token:***@/g'
          
          # æŽ¨é€
          echo "Pushing to origin/$SYNC_BRANCH..."
          git push origin HEAD:"$SYNC_BRANCH" || {
            echo "âœ— Push failed, error details:"
            git push origin HEAD:"$SYNC_BRANCH" 2>&1 || true
            exit 1
          }
          echo "âœ“ Successfully pushed to $SYNC_BRANCH"

      - name: Generate changelog (diff vs main)
        id: changelog
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beanBridge
        run: |
          echo "## æœ¬æ¬¡åŒæ­¥å˜æ›´æ‘˜è¦" > changelog.md
          echo "" >> changelog.md
          echo "### æ–‡ä»¶å˜æ›´" >> changelog.md
          echo '```' >> changelog.md
          git diff origin/main...HEAD --stat -- public/wasm/ public/example/ >> changelog.md || true
          echo '```' >> changelog.md
          echo "" >> changelog.md
          echo "### WASM ä¸Ž example ç›®å½•" >> changelog.md
          echo '```' >> changelog.md
          ls -la public/wasm/ 2>/dev/null || true
          ls -la public/example/ 2>/dev/null || true
          echo '```' >> changelog.md
          cat changelog.md

      - name: Create or update Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        id: create_pr
        working-directory: beanBridge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Creating or updating PR ==="
          echo "has_changes: ${{ steps.changes.outputs.has_changes }}"
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          PREVIEW_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/chore/sync-deg-wasm-examples/"
          
          # éªŒè¯ changelog.md å­˜åœ¨
          if [ ! -f "changelog.md" ]; then
            echo "âœ— changelog.md not found!"
            exit 1
          fi
          
          # å‡†å¤‡ PR body
          {
            echo "è‡ªåŠ¨ä»Ž [double-entry-generator](https://github.com/deb-sig/double-entry-generator) åŒæ­¥ WASM ä¸Žç¤ºä¾‹é…ç½®ã€‚"
            echo ""
            cat changelog.md
            echo ""
            echo "---"
            echo "**é¢„è§ˆåœ°å€ï¼ˆéƒ¨ç½²çº¦ 1â€“2 åˆ†é’ŸåŽç”Ÿæ•ˆï¼‰**"
            echo "$PREVIEW_URL"
            echo ""
            echo "ä»…å½“ä¸Šæ¸¸æœ‰å˜æ›´æ—¶æ­¤åˆ†æ”¯ä¼šæ›´æ–°ï¼Œå¯ä¸Ž main å¯¹æ¯”åŽæŒ‰éœ€åˆå¹¶ã€‚"
          } > pr_body.md
          
          # é¦–å…ˆåˆ—å‡ºæ‰€æœ‰ open çš„ PR ç”¨äºŽè°ƒè¯•
          echo "=== Debug: All open PRs ==="
          ALL_PR_RESULT=$(gh pr list --state open --json number,headRefName,baseRefName,title 2>&1 || echo "Error: $?")
          echo "$ALL_PR_RESULT"
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ PRï¼ˆç²¾ç¡®åŒ¹é…ï¼šbase=main, head=chore/sync-deg-wasm-examplesï¼‰
          echo "=== Checking for existing PR ==="
          echo "Target: head=$SYNC_BRANCH, base=main"
          
          # ä½¿ç”¨æ›´ä¸¥æ ¼çš„æŸ¥è¯¢ï¼šåªæŸ¥è¯¢ä»Ž sync branch åˆ° main çš„ open PR
          PR_RESULT=$(gh pr list --base main --head "$SYNC_BRANCH" --state open --json number,headRefName,baseRefName,title 2>&1 || echo "[]")
          echo "PR list command result:"
          echo "$PR_RESULT"
          echo ""
          
          # å¦‚æžœç»“æžœä¸æ˜¯æœ‰æ•ˆçš„ JSON æ•°ç»„ï¼Œè®¾ç½®ä¸ºç©ºæ•°ç»„
          if ! echo "$PR_RESULT" | jq -e . >/dev/null 2>&1; then
            echo "âš  PR_RESULT is not valid JSON, treating as empty"
            PR_RESULT="[]"
          fi
          
          # ç²¾ç¡®åŒ¹é…ï¼šç¡®ä¿ headRefName å’Œ baseRefName éƒ½æ­£ç¡®
          PR_NUM=$(echo "$PR_RESULT" | jq -r --arg head "$SYNC_BRANCH" --arg base "main" '.[] | select(.headRefName == $head and .baseRefName == $base) | .number' 2>/dev/null | head -1)
          
          echo "=== PR Detection Result ==="
          if [ -n "$PR_NUM" ] && [ "$PR_NUM" != "null" ] && [ "$PR_NUM" != "" ]; then
            echo "âœ“ Found matching PR #$PR_NUM"
            echo "PR details:"
            echo "$PR_RESULT" | jq -r --arg num "$PR_NUM" '.[] | select(.number == ($num | tonumber)) | "  Number: \(.number)\n  Head: \(.headRefName)\n  Base: \(.baseRefName)\n  Title: \(.title)"'
          else
            echo "âœ— No matching PR found (head=$SYNC_BRANCH, base=main)"
            echo "This means we need to create a new PR."
          fi
          echo ""
          
          if [ -n "$PR_NUM" ] && [ "$PR_NUM" != "null" ] && [ "$PR_NUM" != "" ]; then
            echo "=== Updating existing PR #$PR_NUM ==="
            {
              echo "ðŸ”„ **æœ¬æ¬¡åŒæ­¥å˜æ›´**"
              echo ""
              cat changelog.md
              echo ""
              echo "**é¢„è§ˆåœ°å€ï¼ˆéƒ¨ç½²çº¦ 1â€“2 åˆ†é’ŸåŽç”Ÿæ•ˆï¼‰**"
              echo "$PREVIEW_URL"
            } > comment.md
            gh pr comment "$PR_NUM" --body-file comment.md || {
              echo "âš  Failed to add comment to PR #$PR_NUM"
              echo "Error details:"
              gh pr view "$PR_NUM" --json number,headRefName,baseRefName,state,title || true
              exit 1
            }
            echo "âœ“ Comment added to PR #$PR_NUM"
          else
            echo "=== Creating new PR ==="
            echo "PR body preview (first 20 lines):"
            head -20 pr_body.md || true
            echo ""
            
            # éªŒè¯åˆ†æ”¯æ˜¯å¦å­˜åœ¨
            echo "Verifying branch exists..."
            if git show-ref --verify --quiet "refs/heads/$SYNC_BRANCH"; then
              echo "âœ“ Branch $SYNC_BRANCH exists locally"
            else
              echo "âœ— Branch $SYNC_BRANCH does not exist locally"
              git branch -a | grep "$SYNC_BRANCH" || echo "Branch not found in any remote"
            fi
            
            # åˆ›å»º PR
            gh pr create --title "chore(sync-deg): update WASM and example from DEG" --body-file pr_body.md --base main --head "$SYNC_BRANCH" || {
              echo "âœ— Failed to create PR"
              echo ""
              echo "=== Error Diagnosis ==="
              echo "Checking if PR already exists (all states)..."
              gh pr list --base main --head "$SYNC_BRANCH" --state all --json number,headRefName,baseRefName,state,title || true
              echo ""
              echo "Current branch status:"
              git status || true
              echo ""
              echo "Branch info:"
              git branch --show-current || echo "N/A"
              git log --oneline -5 || true
              exit 1
            }
            echo "âœ“ PR created successfully"
          fi

      - name: Workflow Summary (for debugging)
        if: always()
        working-directory: beanBridge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=========================================="
          echo "WORKFLOW SUMMARY - COPY THIS FOR DEBUGGING"
          echo "=========================================="
          echo ""
          echo "=== Changes Detection ==="
          echo "has_changes: ${{ steps.changes.outputs.has_changes }}"
          echo ""
          echo "=== Current Branch ==="
          git branch --show-current || echo "N/A"
          echo ""
          echo "=== Git Status ==="
          git status || echo "N/A"
          echo ""
          echo "=== Staged Files ==="
          git diff --staged --name-status || echo "No staged files"
          echo ""
          echo "=== Public Directory Contents ==="
          echo "--- public/wasm/ ---"
          ls -lh public/wasm/ 2>/dev/null || echo "Directory not found"
          echo ""
          echo "--- public/example/ ---"
          ls -la public/example/ 2>/dev/null | head -20 || echo "Directory not found"
          echo ""
          echo "=== PR Detection ==="
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          PR_RESULT=$(gh pr list --base main --head "$SYNC_BRANCH" --state open --json number,headRefName,baseRefName,title 2>&1 || echo "Error: $?")
          echo "PR list command result:"
          echo "$PR_RESULT"
          echo ""
          PR_NUM=$(echo "$PR_RESULT" | jq -r --arg head "$SYNC_BRANCH" --arg base "main" '.[] | select(.headRefName == $head and .baseRefName == $base) | .number' 2>/dev/null | head -1)
          if [ -n "$PR_NUM" ] && [ "$PR_NUM" != "null" ] && [ "$PR_NUM" != "" ]; then
            echo "Matching PR found: #$PR_NUM"
          else
            echo "No matching PR found (head=$SYNC_BRANCH, base=main)"
          fi
          echo ""
          echo "=== All Open PRs ==="
          gh pr list --state open --json number,headRefName,baseRefName,title 2>&1 || echo "Error listing PRs"
          echo ""
          echo "=== Changelog File ==="
          if [ -f "changelog.md" ]; then
            echo "changelog.md exists, first 30 lines:"
            head -30 changelog.md || echo "Error reading changelog.md"
          else
            echo "changelog.md NOT FOUND"
          fi
          echo ""
          echo "=== Step Execution Status ==="
          echo "Check for changes: ${{ steps.changes.outcome }}"
          echo "Commit and push: ${{ steps.commit.outcome || 'N/A' }}"
          echo "Generate changelog: ${{ steps.changelog.outcome || 'N/A' }}"
          echo "Create or update PR: ${{ steps.create_pr.outcome || 'N/A' }}"
          echo ""
          echo "=== Branch Verification ==="
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          if git show-ref --verify --quiet "refs/heads/$SYNC_BRANCH"; then
            echo "âœ“ Branch $SYNC_BRANCH exists locally"
            echo "Latest commit:"
            git log -1 --oneline "$SYNC_BRANCH" || echo "N/A"
          else
            echo "âœ— Branch $SYNC_BRANCH does not exist locally"
          fi
          echo ""
          echo "=== Remote Branch Status ==="
          git ls-remote --heads origin "$SYNC_BRANCH" || echo "Branch not found on remote"
          echo ""
          echo "=========================================="
          echo "END OF SUMMARY"
          echo "=========================================="
