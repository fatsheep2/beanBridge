var W=Object.defineProperty;var b=(r,e,o)=>e in r?W(r,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):r[e]=o;var C=(r,e,o)=>b(r,typeof e!="symbol"?e+"":e,o);import{f as A,r as v}from"./vendor-l2xnFMpr.js";import{s as M,p as F}from"./wasm-DmpUyrXp.js";const p=class p{constructor(){C(this,"isInitialized",!1);C(this,"initPromise",null)}static getInstance(){return p.instance||(p.instance=new p),p.instance}async init(){if(!this.isInitialized)return this.initPromise?this.initPromise:(this.initPromise=this._doInit(),this.initPromise)}async _doInit(){try{const o="/beanBridge/feat/blockchain-integration/wasm/";console.log("[WASM] 使用路径:",o);const s=await fetch(`${o}wasm_exec.js`,{method:"HEAD"}).catch(()=>null);if(!s||!s.ok)throw new Error("WASM 文件未找到。请确保已运行 `npm run copy-wasm` 或 `pnpm run copy-wasm` 复制 WASM 文件到 public/wasm/ 目录");window.Go||await this.loadScript(`${o}wasm_exec.js`);const n=await fetch(`${o}double-entry-generator.wasm`,{method:"HEAD"}).catch(()=>null);if(!n||!n.ok)throw new Error("WASM 二进制文件未找到。请确保已构建 double-entry-generator 的 WASM 版本");const l=new window.Go,w=await fetch(`${o}double-entry-generator.wasm`);if(!w.ok)throw new Error(`无法加载 WASM 文件: ${w.statusText}`);const P=await WebAssembly.instantiateStreaming(w,l.importObject);l.run(P.instance),await new Promise(t=>setTimeout(t,100)),this.isInitialized=!0,console.log("[WASM] 初始化成功")}catch(e){throw console.error("[WASM] 初始化失败:",e),new Error(`WASM 初始化失败: ${e instanceof Error?e.message:String(e)}`)}}loadScript(e){return new Promise((o,s)=>{if(document.querySelector(`script[src="${e}"]`)){o();return}const n=document.createElement("script");n.src=e,n.onload=()=>o(),n.onerror=l=>s(new Error(`Failed to load script: ${e}`)),document.head.appendChild(n)})}async processFileFromInput(e="fileInput",o="beancount"){if(await this.init(),!window.processFileFromInputWithFormat)throw new Error("WASM 函数未加载");try{const s=await window.processFileFromInputWithFormat(e,o);if(s&&typeof s=="object"){const n=s;return n.error?(console.error("[WASM] 处理文件返回错误:",n.error),{success:!1,error:n.error,output:n.output}):n}return s}catch(s){console.error("[WASM] 处理文件失败:",s);const n=s instanceof Error?s.message:String(s);return n.includes("defaultCommissionAccount")||n.includes("commission")?{success:!1,error:"配置错误: 检测到有手续费交易，但配置文件中缺少 defaultCommissionAccount。请在配置文件中添加 defaultCommissionAccount 字段。"}:{success:!1,error:`处理文件失败: ${n}`}}}async processFile(e,o="beancount"){await this.init();const s=`temp-file-input-${Date.now()}`,n=document.createElement("input");n.type="file",n.id=s,n.style.display="none",document.body.appendChild(n);try{const l=new DataTransfer;l.items.add(e),n.files=l.files;const w=await this.processFileFromInput(s,o);return document.body.removeChild(n),w}catch(l){throw document.getElementById(s)&&document.body.removeChild(n),l}}async processFileContent(e,o,s="beancount"){await this.init();const n=new Blob([o]),l=new File([n],e);return this.processFile(l,s)}async parseYamlConfig(e,o){if(await this.init(),!window.parseYamlConfig)throw new Error("WASM 函数未加载");try{return o?await window.parseYamlConfig(e,o):await window.parseYamlConfig(e)}catch(s){return console.error("[WASM] 解析配置失败:",s),{success:!1,error:`解析配置失败: ${s}`}}}async setProvider(e){if(await this.init(),!window.setProvider)throw new Error("WASM 函数未加载");try{return await window.setProvider(e)}catch(o){return console.error("[WASM] 设置 Provider 失败:",o),{success:!1,error:`设置 Provider 失败: ${o}`}}}async getSupportedProviders(){if(await this.init(),!window.getSupportedProviders)return{success:!1,error:"WASM 函数未加载"};try{return await window.getSupportedProviders()}catch(e){return console.error("[WASM] 获取 Providers 失败:",e),{success:!1,error:`获取 Providers 失败: ${e}`}}}async getCurrentProvider(){if(await this.init(),!window.getCurrentProvider)return{success:!1,error:"WASM 函数未加载"};try{return await window.getCurrentProvider()}catch(e){return console.error("[WASM] 获取当前 Provider 失败:",e),{success:!1,error:`获取当前 Provider 失败: ${e instanceof Error?e.message:String(e)}`}}}async testFunction(e=1,o=2){if(await this.init(),!window.testFunction)throw new Error("WASM 函数未加载");try{return window.testFunction(e,o)}catch(s){return console.error("[WASM] 测试函数失败:",s),{success:!1,message:`测试函数失败: ${s}`}}}};C(p,"instance",null);let E=p;const f=E.getInstance(),m=v(!1),d=v(!1),u=v(null),h=v("alipay"),y=v([]);function I(){const r=async()=>{if(!m.value){d.value=!0,u.value=null;try{await f.init(),m.value=!0;const t=await f.getSupportedProviders();if(t.success&&t.providers)y.value=t.providers,y.value.length>0&&!h.value&&(h.value=y.value[0],await f.setProvider(y.value[0]));else throw new Error("无法获取支持的 providers");const a=await f.getCurrentProvider();a.success&&a.provider&&(h.value=a.provider)}catch(t){throw u.value=t instanceof Error?t.message:String(t),console.error("[useWasm] 初始化失败:",t),t}finally{d.value=!1}}},e=async(t,a="beancount")=>{m.value||await r(),d.value=!0,u.value=null;try{const i=await f.processFile(t,a);return i.success||(u.value=i.error||"处理文件失败"),i}catch(i){const c=i instanceof Error?i.message:String(i);return u.value=c,{success:!1,error:c}}finally{d.value=!1}},o=async(t,a,i="beancount")=>{m.value||await r(),d.value=!0,u.value=null;try{const c=await f.processFileContent(t,a,i);return c.success||(u.value=c.error||"处理文件失败"),c}catch(c){const g=c instanceof Error?c.message:String(c);return u.value=g,{success:!1,error:g}}finally{d.value=!1}},s=async t=>{m.value||await r(),d.value=!0,u.value=null;try{const a=await f.setProvider(t);return a.success?h.value=t:u.value=a.error||"设置 Provider 失败",a}catch(a){const i=a instanceof Error?a.message:String(a);return u.value=i,{success:!1,error:i}}finally{d.value=!1}},n=async(t,a)=>{m.value||await r(),d.value=!0,u.value=null;try{const i=a||h.value,c=await f.parseYamlConfig(t,i);return c.success||(u.value=c.error||"解析配置失败"),c}catch(i){const c=i instanceof Error?i.message:String(i);return u.value=c,{success:!1,error:c}}finally{d.value=!1}},l={alipay:"支付宝",wechat:"微信",icbc:"工商银行",ccb:"建设银行",citic:"中信银行",hsbchk:"汇丰银行香港",htsec:"海通证券",huobi:"火币",td:"道明银行",bmo:"蒙特利尔银行",mt:"美团",jd:"京东",hxsec:"华西证券"},w=t=>l[t]||t,P=A(()=>y.value.map(t=>({value:t,label:w(t)})));return{isInitialized:m,isLoading:d,error:u,currentProvider:h,supportedProviders:y,providersWithNames:P,init:r,processFile:e,processFileContent:o,setProvider:s,parseYamlConfig:n,getProviderDisplayName:w}}const $={parse(r){return F(r)},stringify(r,e){return M(r,e)}},D=$;function N(){const r=I(),e=v(""),o=v("beancount"),s=async t=>{if(await r.init(),t){e.value=t;const a=await r.parseYamlConfig(t);if(!a.success)throw new Error(a.error||"配置解析失败")}},n=async t=>{const a=await r.setProvider(t);if(!a.success)throw new Error(a.error||"设置 Provider 失败")},l=async(t,a="beancount")=>{r.isInitialized.value||await s();const i=r.currentProvider.value;if(!i)throw new Error("请先选择解析器");return await r.setProvider(i),await new Promise(c=>setTimeout(c,100)),e.value&&(await r.parseYamlConfig(e.value,i),await r.setProvider(i),await new Promise(c=>setTimeout(c,100))),await r.setProvider(i),await new Promise(c=>setTimeout(c,50)),await r.processFile(t,a)},w=async(t,a)=>{const i=a||r.currentProvider.value;if(!i)throw new Error("请先选择解析器");console.log(`[useDegWasm] updateConfig: 设置 provider 为 ${i}`),await r.setProvider(i),await new Promise(S=>setTimeout(S,150));const c=D.stringify(t);e.value=c,console.log(`[useDegWasm] updateConfig: 调用 parseYamlConfig，provider: ${i}`);const g=await r.parseYamlConfig(c,i);if(!g.success)throw new Error(g.error||"配置更新失败");return console.log("[useDegWasm] updateConfig: parseYamlConfig 完成，再次确保 provider 正确"),await r.setProvider(i),await new Promise(S=>setTimeout(S,150)),console.log(`[useDegWasm] updateConfig: 完成，provider = ${i}`),g},P=()=>({defaultMinusAccount:"Assets:FIXME",defaultPlusAccount:"Expenses:FIXME",defaultCommissionAccount:"Expenses:Commission:FIXME",defaultCurrency:"CNY",title:"BeanBridge 财务记录"});return{isInitialized:r.isInitialized,isLoading:r.isLoading,error:r.error,currentProvider:r.currentProvider,supportedProviders:r.supportedProviders,providersWithNames:r.providersWithNames,configYaml:e,outputFormat:o,init:s,setProvider:n,processFile:l,updateConfig:w,getDefaultConfig:P,getProviderDisplayName:r.getProviderDisplayName}}export{N as u,D as y};
