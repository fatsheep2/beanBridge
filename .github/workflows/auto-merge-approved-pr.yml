name: Auto-merge Approved PR

on:
  pull_request:
    types: [submitted]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    if: github.event.review.state == 'approved' || github.event.pull_request.title == 'Auto-sync DEG updates'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request_review" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR number: $PR_NUMBER"

      - name: Check PR status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          
          # 获取 PR 详细信息
          PR_INFO=$(gh pr view "$PR_NUMBER" --json state,mergeable,mergeStateStatus,isDraft,reviewDecision 2>/dev/null || echo '{}')
          MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable // "null"')
          MERGE_STATE=$(echo "$PR_INFO" | jq -r '.mergeStateStatus // "unknown"')
          REVIEW_DECISION=$(echo "$PR_INFO" | jq -r '.reviewDecision // "null"')
          
          echo "PR mergeable: $MERGEABLE"
          echo "PR merge state: $MERGE_STATE"
          echo "PR review decision: $REVIEW_DECISION"
          
          # 检查审批状态
          APPROVALS=$(gh pr view "$PR_NUMBER" --json reviews --jq '[.reviews[] | select(.state == "APPROVED")] | length' 2>/dev/null || echo "0")
          echo "Number of approvals: $APPROVALS"
          
          # 如果 PR 可合并且已审批，尝试合并
          if [ "$MERGEABLE" = "true" ] && [ "$MERGE_STATE" != "BLOCKED" ] && [ "$APPROVALS" -gt 0 ]; then
            echo "PR is approved and mergeable, attempting to merge..."
            gh pr merge "$PR_NUMBER" \
              --squash \
              --delete-branch \
              --body "Auto-merged after approval" || {
              echo "Merge failed, checking status..."
              gh pr view "$PR_NUMBER" --json mergeable,mergeStateStatus,statusCheckRollup || true
              exit 1
            }
            echo "✓ PR #$PR_NUMBER merged successfully"
          elif [ "$MERGEABLE" = "true" ] && [ "$APPROVALS" -gt 0 ]; then
            echo "PR is approved but has merge state: $MERGE_STATE"
            echo "Attempting to enable auto-merge..."
            gh pr merge "$PR_NUMBER" --auto --squash 2>&1 || {
              echo "Auto-merge not available"
              echo "PR will be merged when all checks pass"
            }
          else
            echo "PR is not ready to merge"
            echo "Mergeable: $MERGEABLE, Approvals: $APPROVALS, Merge state: $MERGE_STATE"
          fi
