name: Sync DEG Updates

on:
  # æ¯å¤© UTC æ—¶é—´ 2:00 æ£€æŸ¥ä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  schedule:
    - cron: '0 2 * * *'
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“ double-entry-generator å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶è§¦å‘ï¼ˆé€šè¿‡ webhookï¼‰
  repository_dispatch:
    types: [deg-updated]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-deg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout beanBridge
        uses: actions/checkout@v4
        with:
          path: beanBridge
          fetch-depth: 0

      - name: Checkout sync branch (fixed branch for DEG sync)
        working-directory: beanBridge
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          git fetch origin main "$SYNC_BRANCH" 2>/dev/null || true
          if git show-ref --verify --quiet "refs/remotes/origin/$SYNC_BRANCH"; then
            git checkout "$SYNC_BRANCH"
            git merge --no-edit origin/main || true
          else
            git checkout -b "$SYNC_BRANCH" origin/main
          fi

      - name: Checkout double-entry-generator
        uses: actions/checkout@v4
        with:
          repository: deb-sig/double-entry-generator
          path: double-entry-generator
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build WASM
        working-directory: double-entry-generator
        env:
          # å¼ºåˆ¶ä½¿ç”¨å½“å‰å®‰è£…çš„ Goï¼Œä¸éš DEG çš„ go.mod å‡çº§åˆ° 1.24ï¼Œé¿å… wasm_exec.js è·¯å¾„é”™è¯¯
          GOTOOLCHAIN: local
        run: |
          make build-wasm
          ls -lh wasm-dist/

      - name: Copy WASM files
        run: |
          mkdir -p beanBridge/public/wasm
          cp double-entry-generator/wasm-dist/double-entry-generator.wasm beanBridge/public/wasm/
          cp double-entry-generator/wasm-dist/wasm_exec.js beanBridge/public/wasm/
          ls -lh beanBridge/public/wasm/

      - name: Sync example configs
        run: |
          # åŒæ­¥æ‰€æœ‰ provider çš„ç¤ºä¾‹é…ç½®æ–‡ä»¶
          cd double-entry-generator
          for provider_dir in example/*/; do
            provider=$(basename "$provider_dir")
            if [ -f "$provider_dir/config.yaml" ]; then
              echo "Syncing config for $provider..."
              mkdir -p "../beanBridge/public/example/$provider"
              cp "$provider_dir/config.yaml" "../beanBridge/public/example/$provider/" || true
            fi
          done
          echo "Synced example configs:"
          ls -la ../beanBridge/public/example/

      - name: Check for changes
        id: changes
        working-directory: beanBridge
        run: |
          git add public/wasm/ public/example/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git status
          fi

      - name: Commit and push to fixed sync branch
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beanBridge
        run: |
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          git commit -m "chore(sync-deg): update WASM and example from double-entry-generator

          - Update WASM files from double-entry-generator
          - Sync example configurations
          - Auto-generated by GitHub Actions"
          git push origin HEAD:"$SYNC_BRANCH"

      - name: Generate changelog (diff vs main)
        id: changelog
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beanBridge
        run: |
          echo "## æœ¬æ¬¡åŒæ­¥å˜æ›´æ‘˜è¦" > changelog.md
          echo "" >> changelog.md
          echo "### æ–‡ä»¶å˜æ›´" >> changelog.md
          echo '```' >> changelog.md
          git diff origin/main...HEAD --stat -- public/wasm/ public/example/ >> changelog.md || true
          echo '```' >> changelog.md
          echo "" >> changelog.md
          echo "### WASM ä¸Ž example ç›®å½•" >> changelog.md
          echo '```' >> changelog.md
          ls -la public/wasm/ 2>/dev/null || true
          ls -la public/example/ 2>/dev/null || true
          echo '```' >> changelog.md
          cat changelog.md

      - name: Create or update Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: beanBridge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SYNC_BRANCH="chore/sync-deg-wasm-examples"
          PREVIEW_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/chore/sync-deg-wasm-examples/"
          {
            echo "è‡ªåŠ¨ä»Ž [double-entry-generator](https://github.com/deb-sig/double-entry-generator) åŒæ­¥ WASM ä¸Žç¤ºä¾‹é…ç½®ã€‚"
            echo ""
            cat changelog.md
            echo ""
            echo "---"
            echo "**é¢„è§ˆåœ°å€ï¼ˆéƒ¨ç½²çº¦ 1â€“2 åˆ†é’ŸåŽç”Ÿæ•ˆï¼‰**"
            echo "$PREVIEW_URL"
            echo ""
            echo "ä»…å½“ä¸Šæ¸¸æœ‰å˜æ›´æ—¶æ­¤åˆ†æ”¯ä¼šæ›´æ–°ï¼Œå¯ä¸Ž main å¯¹æ¯”åŽæŒ‰éœ€åˆå¹¶ã€‚"
          } > pr_body.md
          if PR_NUM=$(gh pr list --base main --head "$SYNC_BRANCH" --state open --json number -q '.[0].number' 2>/dev/null); then
            echo "PR #$PR_NUM å·²å­˜åœ¨ï¼Œæ·»åŠ æœ¬æ¬¡åŒæ­¥è¯´æ˜Žè¯„è®º"
            {
              echo "ðŸ”„ **æœ¬æ¬¡åŒæ­¥å˜æ›´**"
              echo ""
              cat changelog.md
              echo ""
              echo "**é¢„è§ˆåœ°å€ï¼ˆéƒ¨ç½²çº¦ 1â€“2 åˆ†é’ŸåŽç”Ÿæ•ˆï¼‰**"
              echo "$PREVIEW_URL"
            } > comment.md
            gh pr comment "$PR_NUM" --body-file comment.md
          else
            gh pr create --title "chore(sync-deg): update WASM and example from DEG" --body-file pr_body.md --base main --head "$SYNC_BRANCH"
          fi
