name: Auto-merge Approved PR

on:
  pull_request:
    types: [submitted]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write

# 并发控制：同一 PR 的自动合并只运行一个
# 避免多个审批同时触发多个合并尝试
concurrency:
  group: auto-merge-pr-${{ github.event.pull_request.number || github.event.review.pull_request.number || 'unknown' }}
  cancel-in-progress: false  # 不取消，等待完成（避免重复合并尝试）

jobs:
  auto-merge:
    if: github.event.review.state == 'approved' || github.event.pull_request.title == 'Auto-sync DEG updates'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request_review" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR number: $PR_NUMBER"

      - name: Check PR status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          
          # 获取 PR 详细信息
          PR_INFO=$(gh pr view "$PR_NUMBER" --json state,mergeable,mergeStateStatus,isDraft,reviewDecision,statusCheckRollup 2>/dev/null || echo '{}')
          MERGEABLE=$(echo "$PR_INFO" | jq -r '.mergeable // "null"')
          MERGE_STATE=$(echo "$PR_INFO" | jq -r '.mergeStateStatus // "unknown"')
          REVIEW_DECISION=$(echo "$PR_INFO" | jq -r '.reviewDecision // "null"')
          
          echo "PR mergeable: $MERGEABLE"
          echo "PR merge state: $MERGE_STATE"
          echo "PR review decision: $REVIEW_DECISION"
          
          # 检查审批状态
          APPROVALS=$(gh pr view "$PR_NUMBER" --json reviews --jq '[.reviews[] | select(.state == "APPROVED")] | length' 2>/dev/null || echo "0")
          echo "Number of approvals: $APPROVALS"
          
          # 检查检查状态
          echo "=== PR Status Checks ==="
          gh pr checks "$PR_NUMBER" || echo "No checks found"
          
          # 获取详细的检查信息
          echo "=== Detailed Check Status ==="
          CHECK_STATUS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '.statusCheckRollup[] | "\(.name): \(.status) - \(.conclusion // "pending")"' 2>/dev/null || echo "")
          if [ -n "$CHECK_STATUS" ]; then
            echo "$CHECK_STATUS"
          else
            echo "No status checks found"
          fi
          
          # 如果 PR 可合并且已审批，尝试合并
          if [ "$MERGEABLE" = "true" ] && [ "$MERGE_STATE" != "BLOCKED" ] && [ "$APPROVALS" -gt 0 ]; then
            echo "PR is approved and mergeable, attempting to merge..."
            gh pr merge "$PR_NUMBER" \
              --squash \
              --delete-branch \
              --body "Auto-merged after approval" || {
              echo "Merge failed, checking status..."
              gh pr view "$PR_NUMBER" --json mergeable,mergeStateStatus,statusCheckRollup || true
              exit 1
            }
            echo "✓ PR #$PR_NUMBER merged successfully"
          elif [ "$MERGEABLE" = "true" ] && [ "$APPROVALS" -gt 0 ]; then
            echo "PR is approved but merge state is BLOCKED"
            echo "This usually means required checks are not passing"
            
            # 检查是否有失败的必需检查
            FAILED_CHECKS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '[.statusCheckRollup[] | select(.conclusion == "FAILURE" or .conclusion == "ACTION_REQUIRED")] | length' 2>/dev/null || echo "0")
            PENDING_CHECKS=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '[.statusCheckRollup[] | select(.status == "PENDING" or .status == "IN_PROGRESS")] | length' 2>/dev/null || echo "0")
            
            echo "Failed checks: $FAILED_CHECKS"
            echo "Pending checks: $PENDING_CHECKS"
            
            if [ "$FAILED_CHECKS" -eq 0 ] && [ "$PENDING_CHECKS" -eq 0 ]; then
              echo "No failed or pending checks, attempting merge anyway..."
              gh pr merge "$PR_NUMBER" \
                --squash \
                --delete-branch \
                --body "Auto-merged after approval (no blocking checks)" || {
                echo "Merge still failed, enabling auto-merge..."
                gh pr merge "$PR_NUMBER" --auto --squash 2>&1 || {
                  echo "Auto-merge not available"
                  echo "PR may need manual intervention or branch protection rule changes"
                }
              }
            else
              echo "Attempting to enable auto-merge (will merge when checks pass)..."
              gh pr merge "$PR_NUMBER" --auto --squash 2>&1 || {
                echo "Auto-merge not available"
                echo "PR will be merged when all required checks pass"
              }
            fi
          else
            echo "PR is not ready to merge"
            echo "Mergeable: $MERGEABLE, Approvals: $APPROVALS, Merge state: $MERGE_STATE"
          fi
