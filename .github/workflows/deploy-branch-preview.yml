name: Deploy Branch Preview to GitHub Pages

on:
  push:
    branches:
      # ç›‘å¬æ‰€æœ‰åŠŸèƒ½åˆ†æ”¯ï¼Œæ’é™¤ä¸»åˆ†æ”¯
      - feat/**
      - fix/**
      - dev/**
      - wasm-support  # ä¸´æ—¶æ”¯æŒæ—§åˆ†æ”¯å
      - '!main'
      - '!master'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (e.g., feat/wasm-support)'
        required: true
        default: 'feat/wasm-support'

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write  # éœ€è¦å†™æƒé™ä»¥æ¨é€åˆ° gh-pages åˆ†æ”¯

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼ˆæ¯ä¸ªåˆ†æ”¯ç‹¬ç«‹ï¼‰
concurrency:
  group: "pages-preview-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Get branch name
        id: branch-name
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch }}"
          else
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
          fi
          # æ¸…ç†åˆ†æ”¯åï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™æ–œæ ç”¨äºå±‚çº§
          CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9\/-]/-/g')
          echo "name=$CLEAN_BRANCH" >> $GITHUB_OUTPUT
          echo "original=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch name: $BRANCH_NAME -> $CLEAN_BRANCH"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref_name }}

      - name: Verify WASM files
        run: |
          # æ£€æŸ¥ WASM æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨äºä»“åº“ä¸­
          if [ -f "public/wasm/double-entry-generator.wasm" ] && [ -f "public/wasm/wasm_exec.js" ]; then
            echo "âœ“ WASM æ–‡ä»¶å·²å­˜åœ¨äºä»“åº“ä¸­ï¼Œè·³è¿‡æ„å»ºæ­¥éª¤"
            ls -lh public/wasm/
          else
            echo "âœ— WASM æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·ç¡®ä¿å·²æäº¤ WASM æ–‡ä»¶åˆ°ä»“åº“"
            echo "è¿è¡Œä»¥ä¸‹å‘½ä»¤æ„å»ºå¹¶æäº¤ WASM æ–‡ä»¶ï¼š"
            echo "  cd double-entry-generator && make build-wasm"
            echo "  cp double-entry-generator/wasm-dist/* public/wasm/"
            echo "  git add public/wasm/ && git commit -m 'Add WASM files'"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        env:
          BRANCH_NAME: ${{ steps.branch-name.outputs.name }}
        run: |
          # ä½¿ç”¨åˆ†æ”¯åä½œä¸º base path
          yarn run build --base /beanBridge/$BRANCH_NAME/

      - name: Deploy to GitHub Pages (Branch Subdirectory)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          destination_dir: ${{ steps.branch-name.outputs.name }}  # éƒ¨ç½²åˆ°åˆ†æ”¯åå­ç›®å½•
          keep_files: true  # ä¿ç•™å…¶ä»–éƒ¨ç½²çš„æ–‡ä»¶
          commit_message: "Deploy ${{ steps.branch-name.outputs.original }} branch preview"
      
      - name: Comment PR with preview link
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            const branchName = '${{ steps.branch-name.outputs.name }}';
            const repoName = context.repo.repo;
            const repoOwner = context.repo.owner;
            const previewUrl = `https://${repoOwner}.github.io/${repoName}/${branchName}/`;
            
            console.log(`Preview URL: ${previewUrl}`);
            
            // å¦‚æœæ˜¯ PRï¼Œæ·»åŠ è¯„è®º
            const prs = await github.rest.pulls.list({
              owner: repoOwner,
              repo: repoName,
              state: 'open',
              head: `${repoOwner}:${context.ref.replace('refs/heads/', '')}`
            });
            
            if (prs.data.length > 0) {
              const pr = prs.data[0];
              await github.rest.issues.createComment({
                owner: repoOwner,
                repo: repoName,
                issue_number: pr.number,
                body: `ğŸ‰ **é¢„è§ˆéƒ¨ç½²æˆåŠŸï¼**\n\nâœ¨ é¢„è§ˆåœ°å€: ${previewUrl}\n\nğŸ“ åˆ†æ”¯: \`${{ steps.branch-name.outputs.original }}\`\nâ° éƒ¨ç½²æ—¶é—´: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}`
              });
            }

